<!DOCTYPE html><html><head>
      <title>info</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css">
      
      
      <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.min.js"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="agent-response---orchestrator_workers">Agent Response - orchestrator_workers </h1>
<p><strong>Session ID</strong>: 1d8ed662-c6e2-46f3-a121-2d3cd50b49ae<br>
<strong>Processing Time</strong>: 344.74 seconds</p>
<h2 id="final-response">Final Response </h2>
<p>Here is a solid, detailed technical architecture plan for the HOMEase AI platform, synthesized from the provided documentation and designed for execution by a development team.</p>
<h3 id="executive-summary"><strong>Executive Summary</strong> </h3>
<p>This document presents the comprehensive technical architecture for the HOMEase AI platform, a lead generation service connecting homeowners with aging-in-place (AIP) contractors. The architecture is designed to be scalable, secure, and cost-efficient, directly supporting the business's strategic pivot to a pure-play lead generation model.</p>
<p>The platform is built exclusively on the Google Cloud Platform (GCP) ecosystem, leveraging a serverless, event-driven model to achieve rapid development cycles and operational efficiency. The core components include a Next.js 15 frontend hosted on <strong>Google Cloud Run</strong> (explicitly excluding Vercel), a suite of backend services using <strong>Google Cloud Functions</strong>, and a unified data layer with <strong>Firebase Firestore, Authentication, and Storage</strong>.</p>
<p>Key architectural features include:</p>
<ul>
<li><strong>Asynchronous Workflows:</strong> Core processes like AR assessment analysis and contractor matching are handled asynchronously using Google Cloud Pub/Sub, ensuring a responsive user experience.</li>
<li><strong>Role-Based Access Control (RBAC):</strong> A robust security model using Firebase Custom Claims and NextAuth.js enforces strict permissions for homeowners, contractors, and administrators across the entire application stack.</li>
<li><strong>Integrated Payments &amp; Vetting:</strong> A seamless contractor onboarding and payment system is built using Stripe Connect and Stripe Checkout, automated via secure webhooks.</li>
<li><strong>Automated CI/CD:</strong> A complete DevOps pipeline using GitHub Actions and Google Cloud's Workload Identity Federation enables secure, automated deployments to isolated development, staging, and production environments.</li>
</ul>
<p>This plan provides a blueprint for building a high-performance, secure, and scalable platform poised to capture a significant share of the growing AIP market.</p>
<hr>
<h3 id="1-high-level-system-architecture"><strong>1. High-Level System Architecture</strong> </h3>
<p>HOMEase AI employs a serverless, event-driven architecture hosted entirely on GCP. This model is chosen for its inherent scalability, pay-per-use cost structure, and reduced operational overhead.</p>
<h4 id="11-core-technology-stack"><strong>1.1. Core Technology Stack</strong> </h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication with NextAuth.js v5</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd Gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (Analysis), <a href="http://Fal.ai">Fal.ai</a> (Visualization)</li>
<li><strong>Payments:</strong> Stripe (Connect &amp; Checkout)</li>
<li><strong>CI/CD:</strong> GitHub Actions &amp; Google Cloud Build</li>
</ul>
<h4 id="12-architecture-diagram"><strong>1.2. Architecture Diagram</strong> </h4>
<p>The diagram below illustrates the interaction between system components. The Next.js application on Cloud Run serves as the primary interface, orchestrating calls to backend services and responding to real-time database updates.</p>
<div class="mermaid">graph TD
    subgraph "User Devices"
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph "Google Cloud Platform"
        subgraph "Application &amp; API Tier"
            C(Next.js App on Cloud Run)
        end

        subgraph "Asynchronous Processing Tier"
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
            P[Cloud Function: stripeWebhookHandler]
        end

        subgraph "Data &amp; Persistence Tier"
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph "External Services"
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions &amp; Synchronous Flow
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C
    C -- Authenticates User --&gt; H
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J
    C -- Initiates Onboarding/Payment --&gt; L

    %% Asynchronous Workflows
    C -- Publishes Message --&gt; D
    C -- Publishes Message --&gt; E
    D -- Triggers --&gt; F
    E -- Triggers --&gt; G
    L -- Sends Webhooks --&gt; P

    %% Backend Processing
    F -- Reads/Writes Data --&gt; I
    G -- Reads Files --&gt; J
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Results --&gt; I
    P -- Writes Payment/Vetting Status --&gt; I

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</div><hr>
<h3 id="2-data-modeling--persistence"><strong>2. Data Modeling &amp; Persistence</strong> </h3>
<p>The data layer is built on Firestore, a scalable NoSQL database. The schema is designed with denormalization to optimize for the application's primary read patterns.</p>
<h4 id="21-firestore-collection-schema"><strong>2.1. Firestore Collection Schema</strong> </h4>
<ul>
<li><strong><code>users</code></strong>: Stores profiles for all roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>), identified by their Firebase Auth UID. Contractor profiles include a <code>contractorProfile</code> map containing vetting status, specialties, service area ZIPs, and their <code>stripeAccountId</code>.</li>
<li><strong><code>leads</code></strong>: Represents a homeowner's request for work. It includes denormalized homeowner info, the <code>arAssessmentId</code>, status (<code>new</code>, <code>matching</code>, <code>matched</code>, <code>sold</code>), price, and arrays for <code>matchedContractorIds</code> and <code>purchasedBy</code> contractor IDs.</li>
<li><strong><code>ar-assessments</code></strong>: Contains the results of an AR scan, including <code>status</code> (<code>processing</code>, <code>complete</code>), links to raw data in Cloud Storage, and the final <code>results</code> from the Gemini AI analysis.</li>
<li><strong><code>projects</code></strong>: Tracks a confirmed job between a homeowner and contractor, linking the lead, participants, and final scope.</li>
<li><strong><code>chats</code></strong>: Manages conversation threads, with a <code>messages</code> subcollection for individual messages.</li>
<li><strong><code>reviews</code></strong>: Stores ratings and comments for completed projects. An <code>onWrite</code> Cloud Function aggregates these reviews to update a contractor's average rating in their <code>users</code> document.</li>
<li><strong><code>transactions</code></strong>: Logs all payment events from Stripe for accounting and auditing, using the Stripe session or payment intent ID as the document ID for idempotency.</li>
</ul>
<h4 id="22-firestore-security-rules"><strong>2.2. Firestore Security Rules</strong> </h4>
<p>Security rules are the primary mechanism for enforcing data access control at the database level. They are non-negotiable and protect data even if the application backend is compromised.</p>
<ul>
<li><strong>Users</strong>: Users can read and update their own profiles. Public contractor information is readable by any authenticated user. Admins have full access.</li>
<li><strong>Leads</strong>: A lead can be read only by its owner, a matched contractor, or an admin. Only homeowners can create leads.</li>
<li><strong>AR Assessments</strong>: Can only be accessed by the user who created it or an admin.</li>
<li><strong>Chats &amp; Messages</strong>: Can only be accessed by the participants of the chat.</li>
<li><strong>Reviews</strong>: Are public to read but can only be created by the homeowner of a completed project. Reviews are immutable by users.</li>
</ul>
<hr>
<h3 id="3-authentication--role-based-access-control-rbac"><strong>3. Authentication &amp; Role-Based Access Control (RBAC)</strong> </h3>
<p>A multi-layered RBAC strategy ensures that users can only perform actions and access data appropriate for their role.</p>
<ol>
<li><strong>Authentication Provider</strong>: <strong>NextAuth.js v5</strong> is used with the <strong>Firebase Auth provider</strong>. Firebase securely manages user credentials, social logins, and issues ID tokens.</li>
<li><strong>Authoritative Role Source</strong>: <strong>Firebase Custom Claims</strong> are the single source of truth for user roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>).</li>
<li><strong>Role Assignment</strong>: Upon user signup, a Cloud Function (<code>onUserCreate</code>) is triggered. It reads the user's intended role (set during the signup flow) from a temporary Firestore document and uses the Firebase Admin SDK to write the role as a custom claim to the user's auth token. This process is entirely server-side and secure from client-side manipulation.</li>
<li><strong>Session Propagation</strong>: NextAuth.js is configured to decode the user's ID token upon login, extract the custom <code>role</code> claim, and inject it into the session object.</li>
<li><strong>Permission Enforcement</strong>:
<ul>
<li><strong>Next.js (Server Components &amp; API Routes)</strong>: Server-side code checks <code>session.user.role</code> to authorize access to pages and API endpoints.</li>
<li><strong>Next.js (Client Components)</strong>: The UI is conditionally rendered based on the <code>role</code> available in the <code>useSession()</code> hook.</li>
<li><strong>Cloud Functions</strong>: Callable Functions automatically receive a verified auth <code>context</code> containing the decoded token and its claims, allowing for role checks at the start of any backend process.</li>
<li><strong>Firestore Rules</strong>: Rules use helper functions to read the user's role from their request token (<code>request.auth.token.role</code>) to enforce database-level permissions.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-core-workflows"><strong>4. Core Workflows</strong> </h3>
<p>The platform's primary functions are designed as decoupled, asynchronous workflows to ensure scalability and a responsive user experience.</p>
<h4 id="41-ar-assessment--ai-processing"><strong>4.1. AR Assessment &amp; AI Processing</strong> </h4>
<ol>
<li><strong>Upload</strong>: The homeowner's app uploads raw AR data (images, measurements) directly to a secure path in <strong>Google Cloud Storage</strong>.</li>
<li><strong>Trigger</strong>: Upon successful upload, the app calls a lightweight Next.js API route (<code>/api/ar-assessments/process</code>), which updates the assessment's status in Firestore to <code>'processing'</code> and publishes a message to the <code>ar-assessment-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Process</strong>: An event-driven <strong>Cloud Function (<code>arProcessing</code>)</strong> is triggered by the Pub/Sub message. It downloads the data from Storage, sends it to the <strong>Google Gemini API</strong> for hazard detection and recommendations, and calls <strong><a href="http://Fal.ai">Fal.ai</a></strong> to generate "after" visualizations.</li>
<li><strong>Update</strong>: The function writes the complete analysis back to the assessment's Firestore document and updates its status to <code>'complete'</code>.</li>
<li><strong>Notify</strong>: The homeowner's app, listening for real-time changes to the document, automatically updates the UI to display the full report.</li>
</ol>
<h4 id="42-lead-generation--contractor-matching"><strong>4.2. Lead Generation &amp; Contractor Matching</strong> </h4>
<ol>
<li><strong>Submission</strong>: A homeowner submits a lead request via a Next.js form. The API route (<code>/api/leads/create</code>) validates the data, creates a new lead document in Firestore with a status of <code>'new'</code>, and immediately publishes a message with the <code>leadId</code> to the <code>lead-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Matching</strong>: The <code>leadMatching</code> <strong>Cloud Function</strong> is triggered. It updates the lead status to <code>'matching'</code>, then queries the <code>users</code> collection for approved contractors whose <code>serviceAreaZips</code> and <code>specialties</code> match the lead's requirements.</li>
<li><strong>Ranking &amp; Update</strong>: The function ranks the potential matches (e.g., by average rating, review count) and updates the lead document in Firestore with an array of the top <code>matchedContractorIds</code> and a new status of <code>'matched'</code>.</li>
<li><strong>Notify</strong>: Both the homeowner and the matched contractors receive real-time updates in their dashboards via Firestore listeners, informing them of the match.</li>
</ol>
<h4 id="43-contractor-onboarding--payments"><strong>4.3. Contractor Onboarding &amp; Payments</strong> </h4>
<ol>
<li><strong>Onboarding</strong>: The system uses <strong>Stripe Connect Express</strong>. A contractor initiates onboarding from their dashboard, triggering a server-side process that creates a Stripe Express account and generates a one-time onboarding link. The contractor is redirected to Stripe's co-branded UI to submit their business and bank details.</li>
<li><strong>Verification</strong>: Stripe handles the identity verification asynchronously. When the account is verified, Stripe sends an <code>account.updated</code> event to a secure webhook endpoint.</li>
<li><strong>Pay-Per-Lead Purchase</strong>: An approved contractor can purchase a lead. This action calls a Next.js API route that creates a <strong>Stripe Checkout Session</strong>, embedding the <code>leadId</code> and <code>contractorId</code> in the session's <code>metadata</code>. The contractor is redirected to Stripe's secure payment page.</li>
<li><strong>Webhook Handling</strong>: A single, secure <strong>Cloud Function (<code>stripeWebhookHandler</code>)</strong> with an HTTP trigger acts as the endpoint for all Stripe webhooks. It verifies the Stripe signature of every incoming request.
<ul>
<li>On an <code>account.updated</code> event, it updates the contractor's <code>vettingStatus</code> in Firestore to <code>'approved'</code>.</li>
<li>On a <code>checkout.session.completed</code> event, it reads the <code>metadata</code> to identify the lead and contractor, then updates the lead document in Firestore to grant the contractor access.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-frontend-architecture-nextjs-15-on-cloud-run"><strong>5. Frontend Architecture (Next.js 15 on Cloud Run)</strong> </h3>
<p>The frontend is a monolithic Next.js 15 application using the App Router, prioritizing performance and maintainability with a "Server-First" approach.</p>
<ul>
<li><strong>Component Strategy</strong>: <strong>React Server Components (RSCs)</strong> are used by default to fetch data and render UI on the server, minimizing client-side JavaScript. <strong>Client Components (<code>'use client'</code>)</strong> are used only when necessary for interactivity, such as forms, AR uploaders, and real-time chat windows.</li>
<li><strong>Directory Structure</strong>: A feature-based directory structure (<code>/src/app/(dashboard)/contractor</code>, <code>/src/components/features/leads</code>) keeps the codebase organized.</li>
<li><strong>Styling</strong>: <strong>Tailwind CSS</strong> with <strong>Shadcn/UI</strong> provides a modern, utility-first design system.</li>
<li><strong>Deployment Container</strong>: The application is containerized using a multi-stage <code>Dockerfile</code> that builds the app and copies the optimized standalone output into a lean <code>node:20-alpine</code> image. This creates a small, secure image ideal for Cloud Run.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-cicd"><strong>6. Deployment &amp; DevOps (CI/CD)</strong> </h3>
<p>A fully automated CI/CD pipeline using GitHub Actions ensures reliable and frequent deployments to GCP.</p>
<ul>
<li><strong>Environments</strong>: Three isolated GCP projects (<code>homease-ai-dev</code>, <code>-staging</code>, <code>-prod</code>) provide complete separation for Development, Staging, and Production environments.</li>
<li><strong>Branching Strategy</strong>: A GitFlow model is used. Merges to <code>develop</code>, <code>staging</code>, and <code>main</code> branches trigger deployments to their corresponding environments.</li>
<li><strong>Secure Authentication</strong>: <strong>Workload Identity Federation (WIF)</strong> provides a secure, keyless mechanism for GitHub Actions to authenticate with GCP. This eliminates the need to store long-lived service account keys as GitHub secrets.</li>
<li><strong>Workflows</strong>:
<ol>
<li><strong>PR Validation</strong>: On every pull request to <code>develop</code>, a workflow runs linting, type-checking, and tests to maintain code quality.</li>
<li><strong>Frontend Deployment</strong>: On pushes to key branches, a workflow builds the Next.js Docker image, pushes it to <strong>Google Artifact Registry</strong>, and deploys it as a new revision to <strong>Google Cloud Run</strong>. Secrets are securely injected from <strong>Google Secret Manager</strong>.</li>
<li><strong>Backend Deployment</strong>: A separate workflow, triggered by changes in the <code>/functions</code> directory or rules files, uses the Firebase CLI to deploy Cloud Functions, Firestore rules, and Storage rules to the appropriate GCP project.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="7-security-compliance-and-vetting"><strong>7. Security, Compliance, and Vetting</strong> </h3>
<p>Security is a foundational principle, integrated at every layer of the platform.</p>
<ul>
<li><strong>Application Security</strong>:
<ul>
<li><strong>Content Security Policy (CSP)</strong>: A strict CSP is enforced via Next.js middleware to prevent XSS attacks.</li>
<li><strong>Input Validation</strong>: <strong>Zod</strong> is used to validate all incoming data on every API endpoint and Cloud Function, preventing injection attacks and ensuring data integrity.</li>
<li><strong>Secure Headers</strong>: Standard security headers (HSTS, X-Content-Type-Options) are configured.</li>
</ul>
</li>
<li><strong>Compliance</strong>:
<ul>
<li><strong>CCPA</strong>: The platform provides users with the right to know, delete, and opt-out of data sales (which HOMEase does not do).</li>
<li><strong>'HIPAA-lite'</strong>: While not a covered entity, HOMEase AI treats home accessibility data as sensitive. We practice <strong>data minimization</strong> (collecting only functional needs, not medical diagnoses) and enforce strict access controls.</li>
<li><strong>Encryption</strong>: All data is encrypted in transit (TLS 1.3) and at rest (Google-managed AES-256).</li>
</ul>
</li>
<li><strong>Contractor Vetting</strong>: A multi-stage process ensures contractor quality.
<ol>
<li><strong>Submission</strong>: Contractors upload licenses and proof of insurance to a secure Cloud Storage bucket.</li>
<li><strong>Verification</strong>: An internal admin team verifies these documents and initiates a third-party background check (e.g., via Checkr).</li>
<li><strong>Status Management</strong>: The contractor's <code>vettingStatus</code> (<code>pending</code>, <code>approved</code>, <code>rejected</code>) is managed in their Firestore document via an admin-only dashboard. Only <code>'approved'</code> contractors are eligible for lead matching.</li>
<li><strong>Secure Storage</strong>: Firebase Storage rules ensure that vetting documents can only be uploaded by the contractor and read by authorized administrators.</li>
</ol>
</li>
</ul>
<h2 id="intermediate-steps">Intermediate Steps </h2>
<h3 id="task-coordinator">Task Coordinator </h3>
<p>Task Understanding:<br>
The user requires a detailed technical architecture plan for the HOMEase AI platform, a lead generation service for home modification contractors. The plan must be based on the provided business documentation, adhere to modern web development best practices, and follow a specific technology stack (Next.js 15, Firebase, Google Cloud). A critical constraint is that the platform must NOT use Vercel for hosting, requiring an alternative deployment strategy on Google Cloud. The final output must be a structured plan suitable for execution by a team of engineers.</p>
<p>Execution Strategy:<br>
The project will be executed in three main phases.<br>
Phase 1: Foundation &amp; Core Architecture. This involves establishing the overall system design, data models, authentication, security protocols, and project structure. This phase is critical as it lays the groundwork for all subsequent development.<br>
Phase 2: Feature Implementation. This phase focuses on building the primary user-facing features, including the Next.js frontend, the AR Assessment flow with AI integration, and the core lead generation and contractor matching logic.<br>
Phase 3: Monetization &amp; Operations. This final phase involves integrating the payment system, refining the contractor onboarding process, and establishing a robust CI/CD pipeline for automated testing and deployment to Google Cloud.</p>
<p>The strategy emphasizes an API-first, serverless, and event-driven approach, leveraging Google Cloud and Firebase services to meet the platform's requirements for scalability, security, and rapid development. The explicit constraint of not using Vercel is addressed by deploying the Next.js application to Google Cloud Run.</p>
<p>Subtasks:</p>
<ol>
<li>Define High-Level System Architecture &amp; GCP Deployment Strategy (Priority: 1, Expertise: Cloud Solutions Architect)<br>
Description: Synthesize the provided business documents to define the high-level system architecture. Create a comprehensive architecture diagram illustrating the interaction between the Next.js frontend (on Google Cloud Run), Firebase services (Auth, Firestore, Storage), Google Cloud Functions, and Pub/Sub. This plan must explicitly address the 'no Vercel' constraint by detailing the Google Cloud Run hosting strategy for the Next.js application.<br>
Dependencies: None</li>
<li>Design Firestore Data Models and Security Rules (Priority: 2, Expertise: Database Architect)<br>
Description: Design the Firestore NoSQL database schema. This includes defining collections for users (with roles for homeowners, contractors, admins), leads, ar-assessments, projects, chat messages, and reviews. Plan for necessary data denormalization to optimize read performance for common queries and design the corresponding Firestore Security Rules to enforce access control based on user roles and data ownership.<br>
Dependencies: t1_architecture_overview</li>
<li>Design Authentication and Role-Based Access Control (RBAC) (Priority: 2, Expertise: Senior Full-Stack Engineer with Security Focus)<br>
Description: Plan the authentication and authorization strategy using NextAuth.js v5 with the Firebase Auth provider. Detail the Role-Based Access Control (RBAC) implementation, including how Firebase custom claims will be used to manage user roles. Document the process for validating these roles on both the Next.js server-side components and within the backend Google Cloud Functions.<br>
Dependencies: t1_architecture_overview</li>
<li>Plan AR Assessment and AI Processing Workflow (Priority: 3, Expertise: AI/ML Integration Specialist)<br>
Description: Detail the end-to-end asynchronous workflow for AR-based home assessments. The plan should cover: 1. Client-side data capture and upload to Firebase Storage. 2. Triggering a Pub/Sub event upon upload completion. 3. A powerful, event-driven Google Cloud Function (Gen 2) that retrieves the data, calls the Google Gemini API for analysis and recommendations, and writes the results back to the corresponding Firestore document.<br>
Dependencies: t1_architecture_overview, t2_data_modeling_and_firestore</li>
<li>Design Lead Generation and Contractor Matching Workflow (Priority: 3, Expertise: Senior Backend Engineer)<br>
Description: Design the asynchronous workflow for lead generation and contractor matching. This includes: 1. An API endpoint in Next.js to receive the initial lead data. 2. Saving the lead to Firestore and publishing a 'lead-created' message to Pub/Sub. 3. A Google Cloud Function that consumes this message, executes the contractor matching algorithm based on location, specialization, and availability, and updates the lead document. 4. Specify the use of Firestore real-time listeners on the frontend to notify users of updates.<br>
Dependencies: t1_architecture_overview, t2_data_modeling_and_firestore, t3_auth_and_rbac_design</li>
<li>Plan Next.js Frontend Architecture and Cloud Run Deployment (Priority: 4, Expertise: Senior Next.js Engineer)<br>
Description: Plan the Next.js 15 application architecture using the App Router. Prioritize React Server Components (RSCs) to minimize client-side JavaScript. Design the deployment process for the Next.js application to Google Cloud Run, including creating an optimized multi-stage Dockerfile and a script for managing environment variables and secrets via Google Secret Manager.<br>
Dependencies: t1_architecture_overview</li>
<li>Design Payment and Contractor Onboarding System (Priority: 5, Expertise: Backend Engineer with Stripe Integration Experience)<br>
Description: Design the payment and contractor onboarding process using Stripe. Plan the integration with Stripe Connect for verifying contractor identities and business details. Design the pay-per-lead transaction flow. Specify the architecture for using Google Cloud Functions to handle Stripe webhooks securely, ensuring that events like 'account.updated' or 'checkout.session.completed' reliably update the relevant Firestore documents.<br>
Dependencies: t3_auth_and_rbac_design, t5_lead_matching_workflow</li>
<li>Plan CI/CD Pipeline with GitHub Actions for GCP (Priority: 6, Expertise: DevOps Engineer)<br>
Description: Design the full CI/CD pipeline using GitHub Actions. Create distinct, reusable workflows for: 1. Linting, type-checking, and running tests on every pull request. 2. A deployment workflow for the Next.js application to Google Cloud Run. 3. A separate deployment workflow for Google Cloud Functions, Firestore rules, and other Firebase assets. The plan must include strategies for managing multiple environments (dev, staging, production).<br>
Dependencies: t1_architecture_overview, t6_nextjs_on_gcp_architecture</li>
<li>Develop Security, Compliance, and Contractor Vetting Plan (Priority: 2, Expertise: Security Architect)<br>
Description: Create a comprehensive security and compliance plan. This includes defining a strict Content Security Policy (CSP), detailing input validation strategies using Zod across all endpoints, and outlining the approach to meet 'HIPAA-lite' and CCPA requirements through data minimization, access logs, and encryption. Also, detail the technical implementation of the multi-stage contractor vetting process, specifying how verification status (licenses, insurance, background checks) will be stored and managed securely.<br>
Dependencies: t2_data_modeling_and_firestore, t3_auth_and_rbac_design</li>
</ol>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t1_architecture_overview"</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Cloud Solutions Architect"</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Define High-Level System Architecture &amp; GCP Deployment Strategy"</span><span class="token punctuation">,</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Synthesize the provided business documents to define the high-level system architecture. Create a comprehensive architecture diagram illustrating the interaction between the Next.js frontend (on Google Cloud Run), Firebase services (Auth, Firestore, Storage), Google Cloud Functions, and Pub/Sub. This plan must explicitly address the 'no Vercel' constraint by detailing the Google Cloud Run hosting strategy for the Next.js application."</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t2_data_modeling_and_firestore"</span><span class="token punctuation">,</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Design the Firestore NoSQL database schema. This includes defining collections for users (with roles for homeowners, contractors, admins), leads, ar-assessments, projects, chat messages, and reviews. Plan for necessary data denormalization to optimize read performance for common queries and design the corresponding Firestore Security Rules to enforce access control based on user roles and data ownership."</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Firestore Data Models and Security Rules"</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Database Architect"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t3_auth_and_rbac_design"</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Full-Stack Engineer with Security Focus"</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Plan the authentication and authorization strategy using NextAuth.js v5 with the Firebase Auth provider. Detail the Role-Based Access Control (RBAC) implementation, including how Firebase custom claims will be used to manage user roles. Document the process for validating these roles on both the Next.js server-side components and within the backend Google Cloud Functions."</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Authentication and Role-Based Access Control (RBAC)"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t4_ar_assessment_and_ai_flow"</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"AI/ML Integration Specialist"</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan AR Assessment and AI Processing Workflow"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Detail the end-to-end asynchronous workflow for AR-based home assessments. The plan should cover: 1. Client-side data capture and upload to Firebase Storage. 2. Triggering a Pub/Sub event upon upload completion. 3. A powerful, event-driven Google Cloud Function (Gen 2) that retrieves the data, calls the Google Gemini API for analysis and recommendations, and writes the results back to the corresponding Firestore document."</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span><span class="token punctuation">,</span>
        <span class="token string">"t2_data_modeling_and_firestore"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t5_lead_matching_workflow"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Design the asynchronous workflow for lead generation and contractor matching. This includes: 1. An API endpoint in Next.js to receive the initial lead data. 2. Saving the lead to Firestore and publishing a 'lead-created' message to Pub/Sub. 3. A Google Cloud Function that consumes this message, executes the contractor matching algorithm based on location, specialization, and availability, and updates the lead document. 4. Specify the use of Firestore real-time listeners on the frontend to notify users of updates."</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Backend Engineer"</span><span class="token punctuation">,</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Lead Generation and Contractor Matching Workflow"</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span><span class="token punctuation">,</span>
        <span class="token string">"t2_data_modeling_and_firestore"</span><span class="token punctuation">,</span>
        <span class="token string">"t3_auth_and_rbac_design"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t6_nextjs_on_gcp_architecture"</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Next.js Engineer"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Plan the Next.js 15 application architecture using the App Router. Prioritize React Server Components (RSCs) to minimize client-side JavaScript. Design the deployment process for the Next.js application to Google Cloud Run, including creating an optimized multi-stage Dockerfile and a script for managing environment variables and secrets via Google Secret Manager."</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan Next.js Frontend Architecture and Cloud Run Deployment"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t3_auth_and_rbac_design"</span><span class="token punctuation">,</span>
        <span class="token string">"t5_lead_matching_workflow"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Design the payment and contractor onboarding process using Stripe. Plan the integration with Stripe Connect for verifying contractor identities and business details. Design the pay-per-lead transaction flow. Specify the architecture for using Google Cloud Functions to handle Stripe webhooks securely, ensuring that events like 'account.updated' or 'checkout.session.completed' reliably update the relevant Firestore documents."</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t7_payments_and_onboarding"</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Backend Engineer with Stripe Integration Experience"</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Payment and Contractor Onboarding System"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t1_architecture_overview"</span><span class="token punctuation">,</span>
        <span class="token string">"t6_nextjs_on_gcp_architecture"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"DevOps Engineer"</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t8_cicd_and_devops_plan"</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Design the full CI/CD pipeline using GitHub Actions. Create distinct, reusable workflows for: 1. Linting, type-checking, and running tests on every pull request. 2. A deployment workflow for the Next.js application to Google Cloud Run. 3. A separate deployment workflow for Google Cloud Functions, Firestore rules, and other Firebase assets. The plan must include strategies for managing multiple environments (dev, staging, production)."</span><span class="token punctuation">,</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan CI/CD Pipeline with GitHub Actions for GCP"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"required_expertise"</span><span class="token operator">:</span> <span class="token string">"Security Architect"</span><span class="token punctuation">,</span>
      <span class="token property">"priority"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Create a comprehensive security and compliance plan. This includes defining a strict Content Security Policy (CSP), detailing input validation strategies using Zod across all endpoints, and outlining the approach to meet 'HIPAA-lite' and CCPA requirements through data minimization, access logs, and encryption. Also, detail the technical implementation of the multi-stage contractor vetting process, specifying how verification status (licenses, insurance, background checks) will be stored and managed securely."</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"t9_security_and_compliance"</span><span class="token punctuation">,</span>
      <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"t2_data_modeling_and_firestore"</span><span class="token punctuation">,</span>
        <span class="token string">"t3_auth_and_rbac_design"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Develop Security, Compliance, and Contractor Vetting Plan"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"execution_strategy"</span><span class="token operator">:</span> <span class="token string">"The project will be executed in three main phases. \nPhase 1: Foundation &amp; Core Architecture. This involves establishing the overall system design, data models, authentication, security protocols, and project structure. This phase is critical as it lays the groundwork for all subsequent development.\nPhase 2: Feature Implementation. This phase focuses on building the primary user-facing features, including the Next.js frontend, the AR Assessment flow with AI integration, and the core lead generation and contractor matching logic.\nPhase 3: Monetization &amp; Operations. This final phase involves integrating the payment system, refining the contractor onboarding process, and establishing a robust CI/CD pipeline for automated testing and deployment to Google Cloud.\n\nThe strategy emphasizes an API-first, serverless, and event-driven approach, leveraging Google Cloud and Firebase services to meet the platform's requirements for scalability, security, and rapid development. The explicit constraint of not using Vercel is addressed by deploying the Next.js application to Google Cloud Run."</span><span class="token punctuation">,</span>
  <span class="token property">"task_understanding"</span><span class="token operator">:</span> <span class="token string">"The user requires a detailed technical architecture plan for the HOMEase AI platform, a lead generation service for home modification contractors. The plan must be based on the provided business documentation, adhere to modern web development best practices, and follow a specific technology stack (Next.js 15, Firebase, Google Cloud). A critical constraint is that the platform must NOT use Vercel for hosting, requiring an alternative deployment strategy on Google Cloud. The final output must be a structured plan suitable for execution by a team of engineers."</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="cloud-solutions-architect-specialist">Cloud Solutions Architect Specialist </h3>
<p>Here is the detailed technical architecture plan for the HOMEase AI platform, with a specific focus on the high-level system architecture and deployment strategy on Google Cloud.</p>
<h3 id="homease-ai-technical-architecture-plan"><strong>HOMEase AI: Technical Architecture Plan</strong> </h3>
<p>This document outlines the technical architecture for the HOMEase AI platform. It is designed to be scalable, secure, and capital-efficient, aligning with the business's strategic pivot to a pure-play lead generation model.</p>
<p><strong>A critical constraint of this plan is the explicit exclusion of Vercel for deployment.</strong> The architecture is therefore centered entirely within the Google Cloud Platform (GCP) ecosystem to ensure seamless integration, unified billing, and consolidated security management.</p>
<hr>
<h3 id="1-high-level-system-architecture-1"><strong>1. High-Level System Architecture</strong> </h3>
<p>HOMEase AI will be built on a serverless, event-driven architecture hosted exclusively on Google Cloud Platform. This model is chosen for its inherent scalability, cost-effectiveness (pay-for-what-you-use), and reduced operational overhead, directly supporting the business goals of being "cheaper to run" and "easy to scale."</p>
<p>The architecture is logically divided into four main tiers:</p>
<ol>
<li><strong>Client Tier:</strong> The user-facing applications, including the homeowner's AR-enabled web app and the contractor's dashboard.</li>
<li><strong>Application &amp; API Tier:</strong> The core business logic, serving client requests and orchestrating backend processes. This is handled by a Next.js application and dedicated serverless functions.</li>
<li><strong>Asynchronous Processing Tier:</strong> The engine for handling computationally intensive, long-running, or non-blocking tasks like AR data analysis and lead matching.</li>
<li><strong>Data &amp; Persistence Tier:</strong> The unified backend for storing, managing, and securing all platform data, from user profiles to AR scans.</li>
</ol>
<h4 id="11-core-technology-stack-1"><strong>1.1. Core Technology Stack</strong> </h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (with App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run (for the Next.js application)</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication (integrated with NextAuth.js v5)</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (for analysis), <a href="http://Fal.ai">Fal.ai</a> (for visualization)</li>
<li><strong>Payments:</strong> Stripe</li>
<li><strong>CI/CD:</strong> Google Cloud Build &amp; GitHub Actions</li>
</ul>
<h4 id="12-architecture-diagram-1"><strong>1.2. Architecture Diagram</strong> </h4>
<p>The following diagram illustrates the flow of information and interaction between the system components.</p>
<div class="mermaid">graph TD
    subgraph "User Devices"
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph "Google Cloud Platform"
        subgraph "Application &amp; API Tier"
            C(Next.js App on Cloud Run)
        end

        subgraph "Asynchronous Processing Tier"
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
        end

        subgraph "Data &amp; Persistence Tier"
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph "External Services"
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C

    %% Authentication Flow
    C -- Authenticates User --&gt; H

    %% Synchronous Data Flow
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J

    %% Asynchronous Lead Creation Flow
    C -- Publishes Message --&gt; D
    D -- Triggers --&gt; F
    F -- Reads Data --&gt; I
    F -- Writes Match Results --&gt; I

    %% Asynchronous AR Processing Flow
    C -- Publishes Message --&gt; E
    E -- Triggers --&gt; G
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Analysis Results --&gt; I

    %% Payment Flow
    C -- Initiates Payment --&gt; L

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</div><h4 id="13-component-interaction--key-flows"><strong>1.3. Component Interaction &amp; Key Flows</strong> </h4>
<ul>
<li><strong>User Interaction:</strong> Both Homeowners and Contractors access the platform via a single, responsive Next.js application. Role-based access control (RBAC) within the Next.js backend will serve the appropriate UI and data for each user type.</li>
<li><strong>Authentication:</strong> A user signs up or logs in via the Next.js app. NextAuth.js, using the Firebase Auth adapter, handles the authentication flow. Firebase Auth securely manages user credentials and issues tokens, which are validated by the Next.js backend on every request.</li>
<li><strong>Lead Creation (Event-Driven):</strong>
<ol>
<li>A homeowner submits a new lead request through the Next.js UI.</li>
<li>The Next.js backend API (<code>/api/leads</code>) validates the input (using Zod) and writes the initial lead data to a <code>leads</code> collection in Firestore.</li>
<li>Immediately after, it publishes a message with the <code>leadId</code> to the <code>lead-created</code> Pub/Sub topic. This decouples the API response from the heavy lifting of matching.</li>
<li>The <code>leadMatching</code> Cloud Function, subscribed to this topic, is triggered. It performs the complex logic of finding suitable contractors based on location, specialty, and availability.</li>
<li>The function updates the lead document in Firestore with the matched contractors.</li>
<li>The homeowner and matched contractors receive real-time updates in their dashboards via Firestore's real-time listeners.</li>
</ol>
</li>
<li><strong>AR Processing (Event-Driven):</strong>
<ol>
<li>A homeowner uploads AR scan data (images, measurements) through the Next.js app.</li>
<li>The Next.js backend uploads the large files to Cloud Storage and creates an initial assessment document in Firestore with a <code>status: 'processing'</code> flag.</li>
<li>It then publishes a message with the <code>assessmentId</code> to the <code>ar-assessment-created</code> Pub/Sub topic.</li>
<li>The <code>arProcessing</code> Cloud Function is triggered. This function retrieves the data from Cloud Storage, sends it to the Google Gemini API for hazard detection/recommendations and to <a href="http://Fal.ai">Fal.ai</a> for visualization.</li>
<li>Upon receiving the results, the function updates the assessment document in Firestore with the detailed analysis, hazard list, and generated "after" images. The status is changed to <code>status: 'complete'</code>.</li>
<li>The homeowner's UI, listening to this document, automatically updates to display the completed assessment.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="2-deployment-strategy-nextjs-on-google-cloud-run-no-vercel"><strong>2. Deployment Strategy: Next.js on Google Cloud Run (No Vercel)</strong> </h3>
<p>To adhere to the "no Vercel" constraint while maintaining a modern, scalable deployment for the Next.js 15 application, we will use <strong>Google Cloud Run</strong>. Cloud Run is a fully managed serverless platform that allows us to run stateless containers. It is the ideal GCP-native solution for hosting a full-stack Next.js application.</p>
<h4 id="21-containerization-with-docker"><strong>2.1. Containerization with Docker</strong> </h4>
<p>The Next.js application will be containerized using Docker. A multi-stage <code>Dockerfile</code> will be created to optimize the production image for size and security.</p>
<ul>
<li><strong>Stage 1 (Builder):</strong> Installs dependencies, builds the Next.js application (<code>npm run build</code>), and prunes development-only dependencies.</li>
<li><strong>Stage 2 (Runner):</strong> Copies the built application (<code>.next</code> directory, <code>public</code>, <code>package.json</code>, <code>node_modules</code>) into a lean base image (e.g., <code>node:20-alpine</code>). It exposes the required port (e.g., 3000) and defines the command to start the Next.js server (<code>npm start</code>).</li>
</ul>
<h4 id="22-cicd-with-google-cloud-build-and-artifact-registry"><strong>2.2. CI/CD with Google Cloud Build and Artifact Registry</strong> </h4>
<p>We will implement a fully automated CI/CD pipeline using GitHub Actions and Google Cloud Build.</p>
<ol>
<li><strong>Trigger:</strong> A push or merge to the <code>main</code> or <code>production</code> branch in the GitHub repository triggers the pipeline.</li>
<li><strong>Build:</strong> A <code>cloudbuild.yaml</code> file in the repository root defines the build steps for Google Cloud Build.
<ul>
<li>It builds the Docker image using the project's <code>Dockerfile</code>.</li>
<li>It tags the image with the commit SHA for versioning.</li>
</ul>
</li>
<li><strong>Store:</strong> The newly built container image is pushed to <strong>Google Artifact Registry</strong>, which serves as our private, secure Docker registry.</li>
<li><strong>Deploy:</strong> The final step in the Cloud Build pipeline deploys the new image as a revision to our <strong>Google Cloud Run service</strong>. Cloud Build will use a service account with the necessary permissions (<code>roles/run.admin</code>, <code>roles/iam.serviceAccountUser</code>) to perform this action.</li>
</ol>
<p>This setup ensures that every push to the main branch results in a tested, versioned, and automatically deployed update to the production environment with zero downtime.</p>
<h4 id="23-cloud-run-service-configuration"><strong>2.3. Cloud Run Service Configuration</strong> </h4>
<p>The HOMEase AI Cloud Run service will be configured for performance, scalability, and security:</p>
<ul>
<li><strong>CPU &amp; Memory:</strong> Allocated based on performance testing (e.g., 1 vCPU, 1GiB memory to start).</li>
<li><strong>Scalability:</strong>
<ul>
<li><strong>Min Instances:</strong> Set to <code>1</code> to mitigate cold starts for a better user experience, especially during initial launch phases. Can be set to <code>0</code> to optimize for cost if traffic is highly variable.</li>
<li><strong>Max Instances:</strong> Set to a reasonable limit (e.g., <code>20</code>) to handle traffic spikes while controlling costs.</li>
</ul>
</li>
<li><strong>Concurrency:</strong> Configured to allow multiple concurrent requests per container instance (e.g., 80), which is typical for efficient Node.js applications.</li>
<li><strong>Environment Variables &amp; Secrets:</strong>
<ul>
<li>Non-sensitive variables (e.g., <code>NEXT_PUBLIC_FIREBASE_API_KEY</code>) are set directly in the Cloud Run service configuration.</li>
<li>All sensitive keys (<code>STRIPE_SECRET_KEY</code>, <code>GOOGLE_GENAI_API_KEY</code>, <code>NEXTAUTH_SECRET</code>) will be stored in <strong>Google Secret Manager</strong> and securely mounted into the Cloud Run service at runtime. This is a critical security best practice.</li>
</ul>
</li>
<li><strong>Networking:</strong> The service will be configured to allow public access (all traffic) and will be fronted by a <strong>Google Cloud Load Balancer</strong> with a managed SSL certificate for the custom domain (<code>app.homease.ai</code>). The load balancer also provides CDN capabilities (via Cloud CDN) for caching static assets, further improving performance.</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t1_architecture_overview"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Define High-Level System Architecture &amp; GCP Deployment Strategy"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Cloud Solutions Architect"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="database-architect-specialist">Database Architect Specialist </h3>
<p>Here is the detailed plan for the Firestore data models and security rules for the HOMEase AI platform.</p>
<hr>
<h3 id="3-data-modeling--firestore-schema"><strong>3. Data Modeling &amp; Firestore Schema</strong> </h3>
<p>The Firestore NoSQL database is structured to optimize for the primary access patterns of the application, such as fetching leads for a contractor or displaying a homeowner's project history. The design employs denormalization strategically to ensure fast read performance and reduce the number of queries required for common UI views.</p>
<h4 id="31-collection-structure"><strong>3.1. Collection Structure</strong> </h4>
<p>The following collections form the core of the database schema.</p>
<p><strong>1. <code>users</code></strong><br>
Stores profile information for all user types. A single collection is used to simplify authentication and user management.</p>
<ul>
<li><strong>Document ID:</strong> <code>userId</code> (from Firebase Authentication <code>uid</code>)</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// Firebase Auth UID</span>
  <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"photoURL"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// URL to profile picture</span>
  <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'homeowner', 'contractor', 'admin'</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"phoneNumber"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// optional</span>
  <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"street"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"zip"</span><span class="token operator">:</span> <span class="token string">"string"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// --- Contractor-Specific Fields ---</span>
  <span class="token property">"contractorProfile"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"companyName"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"vettingStatus"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'pending', 'approved', 'rejected'</span>
    <span class="token property">"licenseNumber"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"insuranceVerified"</span><span class="token operator">:</span> <span class="token string">"boolean"</span><span class="token punctuation">,</span>
    <span class="token property">"capsCertified"</span><span class="token operator">:</span> <span class="token string">"boolean"</span><span class="token punctuation">,</span>
    <span class="token property">"specialties"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// e.g., ['ramp-construction', 'bathroom-remodel']</span>
    <span class="token property">"serviceAreaZips"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Array of zip codes served</span>
    <span class="token property">"bio"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token comment">// Denormalized for performance</span>
    <span class="token property">"averageRating"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token comment">// Calculated by a Cloud Function</span>
    <span class="token property">"reviewCount"</span><span class="token operator">:</span> <span class="token string">"number"</span>    <span class="token comment">// Calculated by a Cloud Function</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
<p><strong>2. <code>leads</code></strong><br>
Represents a work request initiated by a homeowner.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"homeownerId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// UID of the creating user</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'new', 'matching', 'matched', 'in_progress', 'closed', 'cancelled'</span>
  <span class="token property">"urgency"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'low', 'medium', 'high'</span>
  <span class="token property">"budgetRange"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// e.g., '$5k-$10k'</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"updatedAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"arAssessmentId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// Link to the 'ar-assessments' document</span>

  <span class="token comment">// --- Denormalized Homeowner Info ---</span>
  <span class="token property">"homeownerInfo"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"zip"</span><span class="token operator">:</span> <span class="token string">"string"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// --- Matched Contractor Info ---</span>
  <span class="token property">"matchedContractorIds"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Array of matched contractor UIDs</span>
  <span class="token property">"viewedByContractors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span> <span class="token comment">// Array of UIDs of contractors who have viewed the lead</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
<p><strong>3. <code>ar-assessments</code></strong><br>
Stores the data and results from an AR scan.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"userId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// UID of the homeowner who created it</span>
  <span class="token property">"leadId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// Link back to the lead if applicable</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'pending', 'processing', 'complete', 'failed'</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"storageRefs"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Paths to raw data in Cloud Storage</span>
    <span class="token property">"video"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"measurementsJson"</span><span class="token operator">:</span> <span class="token string">"string"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"hazards"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token property">"severity"</span><span class="token operator">:</span> <span class="token string">"number"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"recommendations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">"modification"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token property">"details"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"visualizationUrl"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token comment">// URL to the 'after' image from Fal.ai</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
<p><strong>4. <code>projects</code></strong><br>
Represents a confirmed job between a homeowner and a contractor.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"leadId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"homeownerId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"contractorId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// 'upcoming', 'active', 'completed', 'disputed'</span>
  <span class="token property">"scopeOfWork"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token comment">// Finalized SOW</span>
  <span class="token property">"finalBudget"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
  <span class="token property">"startDate"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"completionDate"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"chatId"</span><span class="token operator">:</span> <span class="token string">"string"</span> <span class="token comment">// Link to the 'chats' document for this project</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
<p><strong>5. <code>chats</code></strong><br>
A top-level collection to manage conversation threads.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated (or a composite key like <code>{leadId}_{contractorId}</code>)</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"participantIds"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// [homeownerId, contractorId]</span>
  <span class="token property">"lastMessage"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
    <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li><strong>Subcollection:</strong> <code>messages</code>
<ul>
<li><strong>Document ID:</strong> Auto-generated</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"senderId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">,</span>
  <span class="token property">"readBy"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"string"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
</li>
</ul>
<p><strong>6. <code>reviews</code></strong><br>
Stores ratings and feedback for completed projects.</p>
<ul>
<li><strong>Document ID:</strong> Auto-generated (or <code>projectId</code> for uniqueness)</li>
<li><strong>Structure:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"projectId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"homeownerId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"contractorId"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"rating"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token comment">// 1-5</span>
  <span class="token property">"comment"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"timestamp"</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li><strong>Note:</strong> A Cloud Function will be triggered <code>onWrite</code> to this collection to update the <code>averageRating</code> and <code>reviewCount</code> fields in the contractor's <code>users</code> document.</li>
</ul>
</li>
</ul>
<hr>
<h3 id="32-firestore-security-rules"><strong>3.2. Firestore Security Rules</strong> </h3>
<p>These rules enforce the business logic at the database layer, ensuring users can only access data they are authorized to see. This is a critical security measure that works independently of the application backend.</p>
<p>Filename: <code>firestore.rules</code></p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code>rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>

service cloud<span class="token punctuation">.</span><span class="token property-access">firestore</span> <span class="token punctuation">{</span>
  match <span class="token operator">/</span>databases<span class="token operator">/</span><span class="token punctuation">{</span>database<span class="token punctuation">}</span><span class="token operator">/</span>documents <span class="token punctuation">{</span>

    <span class="token comment">// --- Helper Functions ---</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow keyword-return">return</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span> <span class="token operator">!=</span> <span class="token keyword null nil keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">isUser</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow keyword-return">return</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">==</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">getUserData</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow keyword-return">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">/</span>databases<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token operator">/</span>documents<span class="token operator">/</span>users<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">isRole</span><span class="token punctuation">(</span><span class="token parameter">role</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-let">let</span> userRole <span class="token operator">=</span> <span class="token function">getUserData</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">role</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow keyword-return">return</span> userRole <span class="token operator">==</span> role<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-function">function</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow keyword-return">return</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRole</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// --- Collection Rules ---</span>

    <span class="token comment">// USERS: Users can manage their own profile. Admins have full access.</span>
    <span class="token comment">// Public contractor data is readable by anyone signed in.</span>
    match <span class="token operator">/</span>users<span class="token operator">/</span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getUserData</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">role</span> <span class="token operator">==</span> <span class="token string">'contractor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      allow create<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token property-access">resource</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">;</span>
      allow update<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// No user should be able to delete their own account via a direct API call.</span>
      allow <span class="token keyword keyword-delete">delete</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// LEADS: Homeowners can create/manage their own leads. Matched contractors can read them.</span>
    match <span class="token operator">/</span>leads<span class="token operator">/</span><span class="token punctuation">{</span>leadId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
                    <span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token keyword keyword-in">in</span> resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">matchedContractorIds</span> <span class="token operator">||</span>
                    <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">)</span><span class="token punctuation">;</span>
      allow create<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRole</span><span class="token punctuation">(</span><span class="token string">'homeowner'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     request<span class="token punctuation">.</span><span class="token property-access">resource</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span> <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">;</span>
      allow update<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      allow <span class="token keyword keyword-delete">delete</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// AR-ASSESSMENTS: Only the creating user and admins can access.</span>
    match <span class="token operator">/</span>ar<span class="token operator">-</span>assessments<span class="token operator">/</span><span class="token punctuation">{</span>assessmentId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">userId</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      allow create<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRole</span><span class="token punctuation">(</span><span class="token string">'homeowner'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     request<span class="token punctuation">.</span><span class="token property-access">resource</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">userId</span> <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// PROJECTS: Only the involved homeowner, contractor, or an admin can access.</span>
    match <span class="token operator">/</span>projects<span class="token operator">/</span><span class="token punctuation">{</span>projectId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
                           <span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                           <span class="token function">isUser</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">contractorId</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                           <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Project creation is handled by server-side logic (Cloud Function), not direct client access.</span>
      allow create<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Or a specific server role if configured</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// CHATS &amp; MESSAGES: Only participants in the chat can read/write messages.</span>
    match <span class="token operator">/</span>chats<span class="token operator">/</span><span class="token punctuation">{</span>chatId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      <span class="token comment">// Allow reading/writing the chat document metadata if you are a participant.</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token keyword keyword-in">in</span> resource<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">participantIds</span><span class="token punctuation">;</span>

      <span class="token comment">// Rules for the messages subcollection</span>
      match <span class="token operator">/</span>messages<span class="token operator">/</span><span class="token punctuation">{</span>messageId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
        allow read<span class="token punctuation">,</span> <span class="token literal-property property">create</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                             request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token keyword keyword-in">in</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">/</span>databases<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token operator">/</span>documents<span class="token operator">/</span>chats<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">participantIds</span><span class="token punctuation">;</span>
        <span class="token comment">// Messages are immutable once sent.</span>
        allow update<span class="token punctuation">,</span> <span class="token keyword keyword-delete">delete</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// REVIEWS: Homeowners can create reviews for projects they were part of.</span>
    <span class="token comment">// Reviews are public to read but cannot be modified after creation except by an admin.</span>
    match <span class="token operator">/</span>reviews<span class="token operator">/</span><span class="token punctuation">{</span>reviewId<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Reviews are public</span>
      allow create<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isSignedIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRole</span><span class="token punctuation">(</span><span class="token string">'homeowner'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token comment">// Verify the user was the homeowner on the completed project.</span>
                     <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">/</span>databases<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token operator">/</span>documents<span class="token operator">/</span>projects<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">resource</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">projectId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">homeownerId</span> <span class="token operator">==</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">/</span>databases<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token operator">/</span>documents<span class="token operator">/</span>projects<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">resource</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">projectId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">==</span> <span class="token string">'completed'</span><span class="token punctuation">;</span>
      <span class="token comment">// Reviews are immutable by users.</span>
      allow update<span class="token punctuation">,</span> <span class="token keyword keyword-delete">delete</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t2_data_modeling_and_firestore"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Firestore Data Models and Security Rules"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Database Architect"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="senior-full-stack-engineer-with-security-focus-specialist">Senior Full-Stack Engineer with Security Focus Specialist </h3>
<p>Here is the detailed technical plan for Authentication and Role-Based Access Control (RBAC) for the HOMEase AI platform.</p>
<hr>
<h3 id="3-authentication-and-role-based-access-control-rbac"><strong>3. Authentication and Role-Based Access Control (RBAC)</strong> </h3>
<p>This section details the authentication and authorization strategy for the HOMEase AI platform. The implementation leverages NextAuth.js v5 with the Firebase Auth provider, using Firebase Custom Claims as the cornerstone for a robust and secure Role-Based Access Control (RBAC) system. This approach ensures that user identity is managed securely by Firebase, while access control is enforced consistently across the entire architecture, from the Next.js frontend to the backend Google Cloud Functions.</p>
<h4 id="31-authentication-flow-and-user-signup"><strong>3.1. Authentication Flow and User Signup</strong> </h4>
<p>The authentication flow is designed to be secure and provide a seamless user experience. It differentiates between the platform's two primary user typeshomeowners and contractorsfrom the moment of registration.</p>
<ol>
<li><strong>User Registration:</strong> The Next.js application will feature distinct registration paths: one for "Homeowners" and another for "Contractors."
<ul>
<li>A user selects their desired role and provides standard credentials (email/password or signs in with a social provider like Google).</li>
<li>The frontend client calls the NextAuth.js sign-in/sign-up handler.</li>
</ul>
</li>
<li><strong>Firebase User Creation:</strong> NextAuth.js, configured with the Firebase Adapter, communicates with Firebase Authentication to create a new user record. At this point, the user is authenticated but has no specific role assigned within the system's logic.</li>
<li><strong>Role Assignment (Server-Side Trigger):</strong> To securely assign a role, we will use a <strong><code>onUserCreate</code> Google Cloud Function</strong>.
<ul>
<li>During the signup process in the Next.js app, along with creating the user, a corresponding document is created in a temporary Firestore collection (e.g., <code>pending_users/{userId}</code>) containing the intended role (e.g., <code>{ role: 'homeowner' }</code>).</li>
<li>The <code>onUserCreate</code> function triggers, reads the corresponding document from <code>pending_users</code>, and uses the Firebase Admin SDK to set a <strong>custom claim</strong> on the newly created user account.</li>
<li>After setting the claim, the temporary document in <code>pending_users</code> is deleted. This ensures roles are only ever assigned by trusted server-side code, not by the client.</li>
</ul>
</li>
<li><strong>Session Creation:</strong> Upon subsequent logins, Firebase Auth issues an ID token to the user. This JWT contains the custom claim (e.g., <code>{ "role": "contractor" }</code>), which is cryptographically signed by Google.</li>
<li><strong>Session Propagation:</strong> NextAuth.js receives this ID token. Its session management callbacks are configured to decode the token, extract the custom claim, and inject the <code>role</code> into the NextAuth.js session object. This makes the user's role available throughout the Next.js application.</li>
</ol>
<h4 id="32-role-management-with-firebase-custom-claims"><strong>3.2. Role Management with Firebase Custom Claims</strong> </h4>
<p>Custom claims are the authoritative source for user roles. They are secure, as they can only be modified by a privileged server environment (using the Firebase Admin SDK), and efficient, as they are embedded directly into the user's ID token, eliminating the need for extra database lookups on every request to check permissions.</p>
<ul>
<li>
<p><strong>Defined Roles:</strong></p>
<ul>
<li><code>homeowner</code>: Can create and manage their own AR assessments and leads. Can communicate with matched contractors.</li>
<li><code>contractor</code>: Can view and purchase leads, manage their profile, and communicate with homeowners.</li>
<li><code>admin</code>: Can access an administrative dashboard to manage users, oversee platform activity, and resolve disputes.</li>
</ul>
</li>
<li>
<p><strong>Setting Claims via Cloud Function (<code>functions/src/auth.ts</code>):</strong></p>
</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> functions <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-functions"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> admin <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-admin"</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize Admin SDK if not already done</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  admin<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Triggered on new user creation. Reads the intended role from a
 * 'pending_users' collection and sets it as a custom claim.
 */</span>
<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> assignRoleOnCreate <span class="token operator">=</span> functions<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> firestore <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">firestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> pendingUserRef <span class="token operator">=</span> firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"pending_users"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> userDoc <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> pendingUserRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userDoc<span class="token punctuation">.</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No pending role document found for user: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Defaulting to 'homeowner'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-await">await</span> admin<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCustomUserClaims</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token string">"homeowner"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-const">const</span> userData <span class="token operator">=</span> userDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> role <span class="token operator">=</span> userData<span class="token operator">?.</span>role<span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>role <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token string">"homeowner"</span><span class="token punctuation">,</span> <span class="token string">"contractor"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-await">await</span> admin<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCustomUserClaims</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token punctuation">{</span> role <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Custom claim '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>role<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' set for user: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Default or handle invalid role</span>
      <span class="token keyword keyword-await">await</span> admin<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCustomUserClaims</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token string">"homeowner"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid or no role specified for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Defaulting to 'homeowner'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Clean up the temporary document</span>
    <span class="token keyword keyword-await">await</span> pendingUserRef<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error setting custom claim for user </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="33-nextauthjs-v5-configuration"><strong>3.3. NextAuth.js v5 Configuration</strong> </h4>
<p>The core of the integration lies in the <code>auth.ts</code> configuration file. It connects to Firebase and ensures the custom <code>role</code> claim is added to the session.</p>
<ul>
<li><strong>File:</strong> <code>auth.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> NextAuth <span class="token keyword keyword-from">from</span> <span class="token string">"next-auth"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> FirestoreAdapter <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@auth/firebase-adapter"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> firestore <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/lib/firebase/admin"</span><span class="token punctuation">;</span> <span class="token comment">// Your Firestore admin instance</span>
<span class="token keyword keyword-import">import</span> Google <span class="token keyword keyword-from">from</span> <span class="token string">"next-auth/providers/google"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> Email <span class="token keyword keyword-from">from</span> <span class="token string">"next-auth/providers/email"</span><span class="token punctuation">;</span> <span class="token comment">// For passwordless or email/pass</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> handlers<span class="token punctuation">,</span> signIn<span class="token punctuation">,</span> signOut<span class="token punctuation">,</span> auth <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">NextAuth</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    Google<span class="token punctuation">,</span>
    <span class="token comment">// Add other providers like Email/Password if needed</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  adapter<span class="token operator">:</span> <span class="token function">FirestoreAdapter</span><span class="token punctuation">(</span>firestore<span class="token punctuation">)</span><span class="token punctuation">,</span>
  session<span class="token operator">:</span> <span class="token punctuation">{</span>
    strategy<span class="token operator">:</span> <span class="token string">"jwt"</span><span class="token punctuation">,</span> <span class="token comment">// Using JWTs is essential for this flow</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbacks<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// This callback injects the custom claim into the NextAuth token</span>
    <span class="token keyword keyword-async">async</span> <span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token<span class="token punctuation">,</span> user <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// On initial sign-in, user object is available</span>
        <span class="token keyword keyword-const">const</span> firebaseUser <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> admin<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> role <span class="token operator">=</span> firebaseUser<span class="token punctuation">.</span>customClaims<span class="token operator">?.</span>role <span class="token operator">||</span> <span class="token string">'homeowner'</span><span class="token punctuation">;</span>
        token<span class="token punctuation">.</span>role <span class="token operator">=</span> role<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-return">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// This callback injects the role from the token into the client-side session</span>
    <span class="token keyword keyword-async">async</span> <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> session<span class="token punctuation">,</span> token <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token operator">=</span> token<span class="token punctuation">.</span>sub<span class="token punctuation">;</span> <span class="token comment">// Ensure user ID is in the session</span>
        session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>role <span class="token operator">=</span> token<span class="token punctuation">.</span>role<span class="token punctuation">;</span> <span class="token comment">// Add role to the session user object</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-return">return</span> session<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Augment the default session and user types for TypeScript</span>
<span class="token keyword keyword-declare">declare</span> <span class="token keyword keyword-module">module</span> <span class="token string">"next-auth"</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-interface">interface</span> <span class="token class-name">Session</span> <span class="token punctuation">{</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
      role<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">"homeowner"</span> <span class="token operator">|</span> <span class="token string">"contractor"</span> <span class="token operator">|</span> <span class="token string">"admin"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token operator">&amp;</span> DefaultSession<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="34-enforcing-rbac-in-the-nextjs-application"><strong>3.4. Enforcing RBAC in the Next.js Application</strong> </h4>
<p>With the <code>role</code> available in the session object, enforcing access control becomes straightforward and declarative.</p>
<ul>
<li><strong>Protecting Server Components and Pages:</strong></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// app/contractor/dashboard/page.tsx</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/auth"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"next/navigation"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-default">default</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">ContractorDashboardPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">!==</span> <span class="token string">'contractor'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Or redirect to a dedicated "unauthorized" page</span>
    <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Welcome to your Contractor Dashboard<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token comment">/* Contractor-specific components and data */</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li><strong>Protecting API Routes (Route Handlers):</strong></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// app/api/leads/purchase/route.ts</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/auth"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"next/server"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">!==</span> <span class="token string">'contractor'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">"Forbidden"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Logic for a contractor to purchase a lead...</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> leadId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> leadId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li><strong>Conditionally Rendering UI (Client Components):</strong></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// components/Navbar.tsx</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> useSession <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"next-auth/react"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> Link <span class="token keyword keyword-from">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-function">function</span> <span class="token function">Navbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>nav<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/"</span><span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">===</span> <span class="token string">'contractor'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/contractor/dashboard"</span><span class="token operator">&gt;</span>Dashboard<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token punctuation">{</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">===</span> <span class="token string">'homeowner'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token string">"/homeowner/assessments"</span><span class="token operator">&gt;</span>My Assessments<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>nav<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="35-enforcing-rbac-in-backend-google-cloud-functions"><strong>3.5. Enforcing RBAC in Backend Google Cloud Functions</strong> </h4>
<p>When a Cloud Function is invoked (e.g., for lead matching or AR processing), it must verify that the operation is authorized. For functions called directly from the frontend, <strong>Callable Functions</strong> are the recommended approach as they automatically verify the Firebase Auth ID token.</p>
<ul>
<li><strong>Protecting a Callable Cloud Function:</strong></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// functions/src/leads.ts</span>
<span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> functions <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-functions"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> admin <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-admin"</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * A callable function for a contractor to express interest in a lead.
 * The context object automatically contains verified auth information.
 */</span>
<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> expressInterestInLead <span class="token operator">=</span> functions<span class="token punctuation">.</span>https<span class="token punctuation">.</span><span class="token function">onCall</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. Check for authentication</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-throw">throw</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">functions</span><span class="token punctuation">.</span>https<span class="token punctuation">.</span><span class="token function">HttpsError</span><span class="token punctuation">(</span>
      <span class="token string">"unauthenticated"</span><span class="token punctuation">,</span>
      <span class="token string">"The function must be called while authenticated."</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Check for correct role using the custom claim from the token</span>
  <span class="token keyword keyword-const">const</span> userRole <span class="token operator">=</span> context<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>token<span class="token punctuation">.</span>role<span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>userRole <span class="token operator">!==</span> <span class="token string">"contractor"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-throw">throw</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">functions</span><span class="token punctuation">.</span>https<span class="token punctuation">.</span><span class="token function">HttpsError</span><span class="token punctuation">(</span>
      <span class="token string">"permission-denied"</span><span class="token punctuation">,</span>
      <span class="token string">"Only contractors can express interest in a lead."</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-const">const</span> contractorId <span class="token operator">=</span> context<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> leadId <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-throw">throw</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">functions</span><span class="token punctuation">.</span>https<span class="token punctuation">.</span><span class="token function">HttpsError</span><span class="token punctuation">(</span>
      <span class="token string">"invalid-argument"</span><span class="token punctuation">,</span>
      <span class="token string">"The function must be called with a 'leadId'."</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. Proceed with business logic</span>
  <span class="token comment">// (e.g., update Firestore to link contractor to the lead)</span>
  functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Contractor </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contractorId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is interested in lead </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>leadId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...database logic...</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">"Interest registered successfully."</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>This multi-layered RBAC strategy ensures that user permissions are defined centrally, propagated securely, and enforced at every boundary of the system, providing a robust security posture for the HOMEase AI platform.</p>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t3_auth_and_rbac_design"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Authentication and Role-Based Access Control (RBAC)"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Full-Stack Engineer with Security Focus"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="senior-nextjs-engineer-specialist">Senior Next.js Engineer Specialist </h3>
<p>Here is the detailed technical plan for the HOMEase AI Next.js frontend architecture and its deployment to Google Cloud Run, adhering to the project constraints and requirements.</p>
<hr>
<h3 id="part-2-nextjs-15-frontend-architecture--cloud-run-deployment"><strong>Part 2: Next.js 15 Frontend Architecture &amp; Cloud Run Deployment</strong> </h3>
<p>This section details the architecture of the user-facing Next.js application and the robust deployment strategy on Google Cloud Run, which replaces Vercel as the hosting platform.</p>
<h4 id="21-nextjs-15-application-architecture"><strong>2.1. Next.js 15 Application Architecture</strong> </h4>
<p>The frontend will be a single, monolithic Next.js 15 application serving both homeowners and contractors. The architecture prioritizes performance, security, and maintainability by leveraging the App Router and a "Server-First" component model.</p>
<p><strong>Core Principles:</strong></p>
<ul>
<li><strong>Server-First with App Router:</strong> We will use React Server Components (RSCs) by default for all components. This minimizes the client-side JavaScript bundle size, leading to faster initial page loads and improved SEOcritical for reaching a less tech-savvy demographic and for organic user acquisition.</li>
<li><strong>Progressive Enhancement:</strong> Client Components (<code>'use client'</code>) will be used deliberately and sparingly, only for UI that requires interactivity, browser APIs, or state management (e.g., forms, AR uploaders, real-time chat). This ensures the core content is always accessible, even on slower networks or devices.</li>
<li><strong>Type Safety:</strong> The entire codebase will use TypeScript to enforce type safety, reduce runtime errors, and improve developer experience. Zod will be used for schema validation at the API boundary.</li>
</ul>
<p><strong>Proposed Directory Structure:</strong></p>
<p>A logical, feature-based directory structure will be used to keep the codebase organized and scalable.</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext plaintext"><code>/src
 /app/                               # Next.js App Router
    /api/                           # Backend API Routes (run on Cloud Run)
       /leads/                     # Handles lead creation, updates
       /ar-assessments/            # Handles AR data upload trigger
       /webhooks/                  # For Stripe, etc.
   
    /(marketing)/                   # Route group for public-facing pages
       page.tsx                    # Landing page (Server Component)
       /about/
   
    /(auth)/                        # Route group for authentication
       /login/
       /signup/
   
    /(dashboard)/                   # Protected routes with shared layout
       /homeowner/                 # Homeowner-specific dashboard
          /assessments/[id]/      # View a specific AR assessment (Server Component)
          page.tsx                # Main dashboard (Server Component)
      
       /contractor/                # Contractor-specific dashboard
           /leads/                 # View available leads (Server Component)
           page.tsx                # Performance dashboard (Server Component)
   
    layout.tsx                      # Root layout (provides Auth context)
    global-error.tsx                # Global error boundary

 /components/                        # Reusable React components
    /ui/                            # Primitive components from Shadcn/UI (Button, Card, Input)
    /features/                      # Business-logic components
        /ar/                        # AR Uploader, Visualization viewer (Client Components)
        /auth/                      # SignInForm, SignUpForm (Client Components)
        /leads/                     # LeadCard, LeadDetails (Server Components)

 /lib/                               # Core logic, helpers, SDK initializations
    /firebase/
       admin.ts                    # Server-side Firebase Admin SDK init
       client.ts                   # Client-side Firebase SDK init
    /auth.ts                        # NextAuth.js v5 configuration
    /stripe.ts                      # Stripe SDK initialization
    /validators/                    # Zod schemas for API inputs

 /providers/                         # Client-side context providers
    SessionProvider.tsx             # Wraps app with NextAuth session context

 /types/                             # Global TypeScript definitions
</code></pre><p><strong>Component Strategy: RSC vs. Client Components</strong></p>
<ul>
<li>
<p><strong>Server Components (Default):</strong></p>
<ul>
<li><strong>Data-Display Pages:</strong> <code>contractor/leads</code>, <code>homeowner/assessments/[id]</code>. These pages will fetch data directly from Firestore on the server using the Firebase Admin SDK. This is highly efficient as it avoids client-server request waterfalls.</li>
<li><strong>Static Pages:</strong> <code>/about</code>, <code>/pricing</code>. Content is rendered entirely on the server.</li>
<li><strong>Compositional UI:</strong> <code>LeadCard</code>, <code>Header</code>, <code>Footer</code>. These components receive data as props and do not require client-side state.</li>
</ul>
</li>
<li>
<p><strong>Client Components (<code>'use client'</code>):</strong></p>
<ul>
<li><strong>Interactive Forms:</strong> <code>SignInForm</code>, <code>LeadSubmissionForm</code>. Require <code>useState</code> for input management and <code>onSubmit</code> event handlers.</li>
<li><strong>AR Uploader:</strong> Requires access to browser APIs (File API, Camera) and state to track upload progress.</li>
<li><strong>Real-time Components:</strong> A <code>ChatWindow</code> component that uses <code>useEffect</code> to subscribe to Firestore's real-time listeners for new messages.</li>
<li><strong>Shadcn/UI Wrappers:</strong> Any component from Shadcn/UI that requires interactivity (e.g., <code>DropdownMenu</code>, <code>Dialog</code>, <code>Tabs</code>) must be a Client Component.</li>
</ul>
</li>
</ul>
<h4 id="22-deployment-to-google-cloud-run"><strong>2.2. Deployment to Google Cloud Run</strong> </h4>
<p>The Next.js application will be containerized with Docker and deployed as a serverless service on Google Cloud Run. This provides auto-scaling, pay-per-use billing, and seamless integration with other GCP services.</p>
<p><strong>Optimized <code>next.config.mjs</code> for Cloud Run:</strong></p>
<p>To create a minimal production server, the Next.js config will enable the standalone output mode.</p>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token comment">// next.config.mjs</span>
<span class="token doc-comment comment">/** <span class="token keyword keyword-@type">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword keyword-import">import</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NextConfig<span class="token punctuation">}</span></span> */</span>
<span class="token keyword keyword-const">const</span> nextConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Enables the standalone output, which creates a smaller deployment footprint</span>
  <span class="token comment">// by copying only necessary files and node_modules into the .next/standalone folder.</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token string">'standalone'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">experimental</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Recommended for serverless environments to optimize cold starts</span>
    <span class="token literal-property property">serverComponentsExternalPackages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@google-cloud/firestore'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module keyword-export">export</span> <span class="token keyword module keyword-default">default</span> nextConfig<span class="token punctuation">;</span>
</code></pre><p><strong>Optimized Multi-Stage <code>Dockerfile</code>:</strong></p>
<p>This Dockerfile creates a small, secure, and efficient production image.</p>
<pre data-role="codeBlock" data-info="dockerfile" class="language-dockerfile dockerfile"><code><span class="token comment"># Stage 1: Builder - Install dependencies and build the application</span>
<span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> node:20-slim <span class="token keyword keyword-AS">AS</span> builder</span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>

<span class="token comment"># Install dependencies</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> package*.json ./</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> npm ci</span>

<span class="token comment"># Copy source code</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> . .</span>

<span class="token comment"># Set build-time environment variables if needed (e.g., from Cloud Build)</span>
<span class="token comment"># ARG NEXT_PUBLIC_FIREBASE_API_KEY</span>
<span class="token comment"># ENV NEXT_PUBLIC_FIREBASE_API_KEY=$NEXT_PUBLIC_FIREBASE_API_KEY</span>

<span class="token comment"># Build the Next.js application</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> npm run build</span>

<span class="token comment"># ---</span>

<span class="token comment"># Stage 2: Runner - Create the final, lean production image</span>
<span class="token instruction"><span class="token keyword keyword-FROM">FROM</span> node:20-alpine <span class="token keyword keyword-AS">AS</span> runner</span>
<span class="token instruction"><span class="token keyword keyword-WORKDIR">WORKDIR</span> /app</span>

<span class="token comment"># Create a non-root user for security</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> addgroup --system --gid 1001 nodejs</span>
<span class="token instruction"><span class="token keyword keyword-RUN">RUN</span> adduser --system --uid 1001 nextjs</span>

<span class="token comment"># Copy the standalone output from the builder stage</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/.next/standalone ./</span>
<span class="token comment"># Copy the static assets</span>
<span class="token instruction"><span class="token keyword keyword-COPY">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/public ./public</span>

<span class="token comment"># Set the user to the non-root user</span>
<span class="token instruction"><span class="token keyword keyword-USER">USER</span> nextjs</span>

<span class="token comment"># Expose the port the app will run on</span>
<span class="token instruction"><span class="token keyword keyword-EXPOSE">EXPOSE</span> 3000</span>

<span class="token comment"># Set the default port for Next.js</span>
<span class="token instruction"><span class="token keyword keyword-ENV">ENV</span> PORT 3000</span>

<span class="token comment"># Start the Next.js server</span>
<span class="token instruction"><span class="token keyword keyword-CMD">CMD</span> [<span class="token string">"node"</span>, <span class="token string">"server.js"</span>]</span>
</code></pre><h4 id="23-environment-variable-and-secret-management"><strong>2.3. Environment Variable and Secret Management</strong> </h4>
<p>A robust and secure strategy for managing configuration is essential.</p>
<ul>
<li><strong>Google Secret Manager:</strong> All sensitive values will be stored here. This is the single source of truth for secrets.
<ul>
<li><code>NEXTAUTH_SECRET</code>: Session encryption key.</li>
<li><code>STRIPE_SECRET_KEY</code>: Stripe API secret key.</li>
<li><code>GOOGLE_GENAI_API_KEY</code>: Google Gemini API key.</li>
<li><code>FIREBASE_SERVICE_ACCOUNT_JSON</code>: Service account key for server-side Firebase Admin access.</li>
</ul>
</li>
<li><strong>Cloud Run Environment Variables:</strong> Only non-sensitive, public configuration will be set here.
<ul>
<li><code>NEXT_PUBLIC_FIREBASE_API_KEY</code>: The public Firebase SDK key.</li>
<li><code>NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</code>: The public Stripe key.</li>
<li><code>NEXTAUTH_URL</code>: The canonical URL of the deployed application.</li>
</ul>
</li>
</ul>
<p><strong>Setup Script (<code>setup_secrets.sh</code>)</strong></p>
<p>This script can be run by a lead developer or a CI/CD pipeline to provision secrets in GCP. It assumes the <code>gcloud</code> CLI is authenticated and configured.</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># Exit on error</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span>

<span class="token comment"># --- Configuration ---</span>
<span class="token assign-left variable">PROJECT_ID</span><span class="token operator">=</span><span class="token string">"your-gcp-project-id"</span> <span class="token comment"># CHANGE THIS</span>
<span class="token assign-left variable">REGION</span><span class="token operator">=</span><span class="token string">"us-central1"</span> <span class="token comment"># CHANGE THIS</span>
<span class="token assign-left variable">SERVICE_NAME</span><span class="token operator">=</span><span class="token string">"homease-ai-frontend"</span>

<span class="token comment"># Set the project for all subsequent gcloud commands</span>
gcloud config <span class="token builtin class-name">set</span> project <span class="token variable">$PROJECT_ID</span>

<span class="token builtin class-name">echo</span> <span class="token string">"--- Enabling required Google Cloud APIs ---"</span>
gcloud services <span class="token builtin class-name">enable</span> secretmanager.googleapis.com
gcloud services <span class="token builtin class-name">enable</span> run.googleapis.com

<span class="token builtin class-name">echo</span> <span class="token string">"--- Creating secrets in Secret Manager (if they don't exist) ---"</span>

<span class="token comment"># Function to create or update a secret</span>
<span class="token function-name function">create_secret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">SECRET_NAME</span><span class="token operator">=</span><span class="token variable">$1</span>
  <span class="token builtin class-name">local</span> <span class="token assign-left variable">SECRET_VALUE</span><span class="token operator">=</span><span class="token variable">$2</span>
  <span class="token keyword keyword-if">if</span> gcloud secrets describe <span class="token string">"<span class="token variable">$SECRET_NAME</span>"</span> <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword keyword-then">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Secret '<span class="token variable">$SECRET_NAME</span>' already exists. Adding new version."</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$SECRET_VALUE</span>"</span> <span class="token operator">|</span> gcloud secrets versions <span class="token function">add</span> <span class="token string">"<span class="token variable">$SECRET_NAME</span>"</span> --data-file<span class="token operator">=</span>-
  <span class="token keyword keyword-else">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Creating secret '<span class="token variable">$SECRET_NAME</span>'."</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$SECRET_VALUE</span>"</span> <span class="token operator">|</span> gcloud secrets create <span class="token string">"<span class="token variable">$SECRET_NAME</span>"</span> --data-file<span class="token operator">=</span>- --replication-policy<span class="token operator">=</span><span class="token string">"automatic"</span>
  <span class="token keyword keyword-fi">fi</span>
<span class="token punctuation">}</span>

<span class="token comment"># --- IMPORTANT ---</span>
<span class="token comment"># In a real environment, you would source these values from a secure location,</span>
<span class="token comment"># like a local .env file (added to .gitignore) or CI/CD secret variables.</span>
<span class="token comment"># For this example, we use placeholder values.</span>
<span class="token comment">#</span>
<span class="token comment"># Example:</span>
<span class="token comment"># read -sp "Enter your NEXTAUTH_SECRET: " NEXTAUTH_SECRET_VAL</span>
<span class="token comment"># create_secret "NEXTAUTH_SECRET" "$NEXTAUTH_SECRET_VAL"</span>

create_secret <span class="token string">"NEXTAUTH_SECRET"</span> <span class="token string">"REPLACE_WITH_REAL_SECRET_USING_openssl_rand_base64_32"</span>
create_secret <span class="token string">"STRIPE_SECRET_KEY"</span> <span class="token string">"sk_test_REPLACE_WITH_REAL_SECRET"</span>
create_secret <span class="token string">"GOOGLE_GENAI_API_KEY"</span> <span class="token string">"REPLACE_WITH_REAL_GEMINI_KEY"</span>

<span class="token comment"># For the service account JSON, it's better to pipe the file directly</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Creating Firebase Service Account secret from file 'firebase-service-account.json'..."</span>
<span class="token comment"># Ensure you have the service account JSON file locally for this step</span>
create_secret <span class="token string">"FIREBASE_SERVICE_ACCOUNT_JSON"</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> ./path/to/your/firebase-service-account.json<span class="token variable">)</span></span>"</span>

<span class="token builtin class-name">echo</span> <span class="token string">"--- Secrets created successfully ---"</span>

<span class="token builtin class-name">echo</span> <span class="token string">"--- Granting Cloud Run service access to secrets ---"</span>
<span class="token comment"># Get the service account used by Cloud Run</span>
<span class="token comment"># Note: This command assumes the default service account. If you create a dedicated one, use that email instead.</span>
<span class="token assign-left variable">CLOUD_RUN_SA_EMAIL</span><span class="token operator">=</span><span class="token string">"$(gcloud projects get-iam-policy <span class="token variable">$PROJECT_ID</span> --flatten="bindings[].members" --format='table(bindings.members)' --filter="</span>bindings.role:roles/run.invoker<span class="token string">" | grep "</span>compute-system.iam.gserviceaccount.com<span class="token string">" | head -n 1)"</span> <span class="token comment"># This is a bit complex, better to use the project number based default SA</span>
<span class="token assign-left variable">PROJECT_NUMBER</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>gcloud projects describe $PROJECT_ID <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">'value(projectNumber)'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">CLOUD_RUN_SA_EMAIL</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${PROJECT_NUMBER}</span>-compute@developer.gserviceaccount.com"</span>


<span class="token comment"># Grant the 'Secret Manager Secret Accessor' role to the Cloud Run service account for each secret</span>
gcloud secrets add-iam-policy-binding <span class="token string">"NEXTAUTH_SECRET"</span> <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:<span class="token variable">${CLOUD_RUN_SA_EMAIL}</span>"</span> <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/secretmanager.secretAccessor"</span> <span class="token parameter variable">--quiet</span>
gcloud secrets add-iam-policy-binding <span class="token string">"STRIPE_SECRET_KEY"</span> <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:<span class="token variable">${CLOUD_RUN_SA_EMAIL}</span>"</span> <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/secretmanager.secretAccessor"</span> <span class="token parameter variable">--quiet</span>
gcloud secrets add-iam-policy-binding <span class="token string">"GOOGLE_GENAI_API_KEY"</span> <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:<span class="token variable">${CLOUD_RUN_SA_EMAIL}</span>"</span> <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/secretmanager.secretAccessor"</span> <span class="token parameter variable">--quiet</span>
gcloud secrets add-iam-policy-binding <span class="token string">"FIREBASE_SERVICE_ACCOUNT_JSON"</span> <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:<span class="token variable">${CLOUD_RUN_SA_EMAIL}</span>"</span> <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/secretmanager.secretAccessor"</span> <span class="token parameter variable">--quiet</span>

<span class="token builtin class-name">echo</span> <span class="token string">"--- Permissions granted. You can now deploy your Cloud Run service. ---"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Use the following flags in your 'gcloud run deploy' command:"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"--set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"--set-secrets=STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"--set-secrets=GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"--set-secrets=FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest"</span>
</code></pre><p><strong>Deployment Command Example (for <code>cloudbuild.yaml</code>):</strong></p>
<p>This command builds the container, pushes it to Artifact Registry, and deploys it to Cloud Run, securely mounting the secrets.</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># In your cloudbuild.yaml file</span>
<span class="token key atrule">steps</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'gcr.io/cloud-builders/docker'</span>
  <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token string">'-t'</span><span class="token punctuation">,</span> <span class="token string">'${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span>
  
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'gcr.io/cloud-builders/docker'</span>
  <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}'</span><span class="token punctuation">]</span>
  
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'gcr.io/google.com/cloudsdktool/cloud-sdk'</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> gcloud
  <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'run'</span>
    <span class="token punctuation">-</span> <span class="token string">'deploy'</span>
    <span class="token punctuation">-</span> <span class="token string">'${_SERVICE_NAME}'</span>
    <span class="token punctuation">-</span> <span class="token string">'--image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${COMMIT_SHA}'</span>
    <span class="token punctuation">-</span> <span class="token string">'--region=${_REGION}'</span>
    <span class="token punctuation">-</span> <span class="token string">'--platform=managed'</span>
    <span class="token punctuation">-</span> <span class="token string">'--allow-unauthenticated'</span> <span class="token comment"># Or configure IAM for authenticated access</span>
    <span class="token comment"># Mount secrets as environment variables</span>
    <span class="token punctuation">-</span> <span class="token string">'--set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest,STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest,GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest,FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest'</span>
    <span class="token comment"># Set non-sensitive environment variables</span>
    <span class="token punctuation">-</span> <span class="token string">'--update-env-vars=NEXTAUTH_URL=https://${_SERVICE_NAME}-your-unique-hash-${_REGION}.a.run.app'</span>
</code></pre><p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t6_nextjs_on_gcp_architecture"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan Next.js Frontend Architecture and Cloud Run Deployment"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Next.js Engineer"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="security-architect-specialist">Security Architect Specialist </h3>
<p>Here is the detailed technical architecture plan for Security, Compliance, and Contractor Vetting for the HOMEase AI platform.</p>
<hr>
<h3 id="7-security-compliance-and-vetting-1"><strong>7. Security, Compliance, and Vetting</strong> </h3>
<p>A robust security and compliance posture is paramount for building trust with both homeowners and contractors, especially given the sensitive nature of the data involved. This section outlines a multi-layered strategy encompassing application security, data privacy, regulatory compliance, and a rigorous contractor quality assurance process.</p>
<h4 id="71-comprehensive-application-security"><strong>7.1. Comprehensive Application Security</strong> </h4>
<p>Security is integrated at every layer of the platform, from the frontend to the database.</p>
<p><strong>7.1.1. Network and Transport Layer Security</strong><br>
All communication between clients (web browser, mobile app) and HOMEase AI servers will be encrypted using Transport Layer Security (TLS) 1.3. HTTPS will be strictly enforced across all domains and subdomains via configurations in the Google Cloud Load Balancer, which will terminate SSL/TLS before routing traffic to the Next.js application running on Cloud Run.</p>
<p><strong>7.1.2. Content Security Policy (CSP)</strong><br>
To mitigate Cross-Site Scripting (XSS) and other code injection vulnerabilities, a strict Content Security Policy (CSP) will be implemented. This is configured as a response header in the Next.js middleware.</p>
<ul>
<li><strong>File:</strong> <code>middleware.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> NextRequest<span class="token punctuation">,</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'next/server'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-function">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> nonce <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> cspHeader <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    default-src 'self';
    script-src 'self' 'nonce-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nonce<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' 'strict-dynamic' https: http:;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https://firebasestorage.googleapis.com https://*.googleusercontent.com;
    connect-src 'self' https://*.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com wss://firestore.googleapis.com https://api.stripe.com https://api.fal.ai;
    font-src 'self' https://fonts.gstatic.com;
    frame-src 'self' https://js.stripe.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    block-all-mixed-content;
    upgrade-insecure-requests;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token keyword keyword-const">const</span> requestHeaders <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  requestHeaders<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'x-nonce'</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span><span class="token punctuation">;</span>
  requestHeaders<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
    <span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span>
    cspHeader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s{2,}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headers<span class="token operator">:</span> requestHeaders<span class="token punctuation">,</span>
    request<span class="token operator">:</span> <span class="token punctuation">{</span>
      headers<span class="token operator">:</span> requestHeaders<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  matcher<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      source<span class="token operator">:</span> <span class="token string">'/((?!api|_next/static|_next/image|favicon.ico).*)'</span><span class="token punctuation">,</span>
      missing<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'header'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">'next-router-prefetch'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'header'</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">'purpose'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'prefetch'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p><strong>7.1.3. Input Validation with Zod</strong><br>
All data entering the system, whether through Next.js API Routes or Google Cloud Functions, will be rigorously validated using Zod. This prevents data corruption, NoSQL injection, and other payload-based attacks by ensuring every piece of data conforms to a predefined schema.</p>
<ul>
<li><strong>Example: Lead Creation Schema</strong> (<code>/lib/schemas/lead.ts</code>)</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'zod'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> createLeadSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  urgency<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">,</span> <span class="token string">'medium'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  budgetRange<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Budget range is required."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Please provide more details."</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  arAssessmentId<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Can be linked later</span>
  homeownerAddress<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    street<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    city<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    zip<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\d{5}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">"Invalid ZIP code"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li><strong>Usage in an API Route</strong> (<code>/app/api/leads/route.ts</code>)</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/auth"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> createLeadSchema <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/lib/schemas/lead"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"next/server"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">!==</span> <span class="token string">'homeowner'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">"Forbidden"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> body <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> validatedData <span class="token operator">=</span> createLeadSchema<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ... proceed with validatedData to create the lead in Firestore ...</span>

    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> leadId<span class="token operator">:</span> <span class="token string">"..."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">201</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">z</span><span class="token punctuation">.</span>ZodError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> error<span class="token punctuation">.</span>errors <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">"Internal Server Error"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="72-data-privacy-and-compliance-framework"><strong>7.2. Data Privacy and Compliance Framework</strong> </h4>
<p>We operate on the principles of Privacy by Design and Data Minimization, ensuring compliance with regulations like CCPA and adopting a 'HIPAA-lite' mindset for sensitive information.</p>
<p><strong>7.2.1. Adherence to CCPA (California Consumer Privacy Act)</strong><br>
The platform will provide users with the rights guaranteed under CCPA:</p>
<ul>
<li><strong>Right to Know:</strong> All user-specific data (profile information, leads, projects) is accessible to the user through their respective dashboard.</li>
<li><strong>Right to Delete:</strong> A user can initiate an account deletion request from their profile settings. This triggers a secure <code>onUserDelete</code> Cloud Function that performs a "soft delete" by anonymizing PII in historical records (e.g., <code>leads</code>, <code>projects</code>) to preserve data integrity for analytics, and performs a "hard delete" of the user's document in the <code>users</code> collection and their associated documents in Firebase Storage.</li>
<li><strong>Right to Opt-Out:</strong> HOMEase AI does not sell personal information. Our privacy policy will clearly state how data is usedsolely for the purpose of matching homeowners with contractors.</li>
</ul>
<p><strong>7.2.2. 'HIPAA-lite' Approach for Sensitive Data</strong><br>
While HOMEase AI is not a "Covered Entity" under HIPAA, we recognize that information about home accessibility needs can imply sensitive health information. We therefore adopt best practices for handling this data:</p>
<ul>
<li><strong>Data Minimization:</strong> We will never ask for specific medical conditions or diagnoses. The AR assessment focuses on physical barriers and functional needs (e.g., "difficulty navigating stairs," "need for grab bars"), not the underlying medical reason.</li>
<li><strong>Strict Access Control:</strong> As defined in the RBAC and Firestore Rules sections, access to lead details is strictly limited to the homeowner, the contractors they are matched with, and authorized admin personnel for support purposes.</li>
<li><strong>Clear Consent:</strong> The user must provide explicit consent before their AR assessment and lead details are shared with any contractors.</li>
</ul>
<p><strong>7.2.3. Data Encryption</strong></p>
<ul>
<li><strong>At Rest:</strong> All data stored in Google Firestore and Google Cloud Storage is automatically encrypted at rest using AES-256, managed by Google Cloud.</li>
<li><strong>In Transit:</strong> All data is encrypted in transit using TLS 1.3, as described above.</li>
</ul>
<p><strong>7.2.4. Auditing and Access Logging</strong><br>
To ensure accountability and detect unauthorized access, a two-tiered auditing strategy will be implemented:</p>
<ol>
<li><strong>Platform-Level Auditing:</strong> Google Cloud Audit Logs will be enabled for all services (Firestore, Cloud Functions, Cloud Storage). This automatically logs all API calls, including administrative actions and system-level data access.</li>
<li><strong>Application-Level Auditing:</strong> For highly sensitive actions within the application (e.g., an admin viewing a user's PII or a contractor purchasing a lead), a dedicated <code>audit_logs</code> collection will be used in Firestore. A server-side function will write a new document for each event, capturing who performed the action, what action was taken, on which resource, and when.</li>
</ol>
<h4 id="73-contractor-vetting-and-quality-assurance"><strong>7.3. Contractor Vetting and Quality Assurance</strong> </h4>
<p>The platform's reputation hinges on the quality and trustworthiness of its contractors. A rigorous, multi-stage vetting process is a cornerstone of our value proposition.</p>
<p><strong>7.3.1. Vetting Process Overview</strong></p>
<ol>
<li><strong>Initial Signup:</strong> A contractor signs up and creates a profile. Their <code>vettingStatus</code> in the <code>users</code> collection is set to <code>'pending'</code>. Their profile is not public or eligible to receive leads.</li>
<li><strong>Document Submission:</strong> The contractor is guided through a secure portal to upload required documentation:
<ul>
<li>Proof of General Liability Insurance</li>
<li>State/Local Business License</li>
<li>Relevant Certifications (e.g., CAPS designation)</li>
</ul>
</li>
<li><strong>Third-Party Background Check:</strong> The contractor must consent to and pass a background check initiated through an integrated third-party service (e.g., Checkr).</li>
<li><strong>Admin Review:</strong> An internal administrator is notified of the completed application. The admin verifies the submitted documents, checks the license against state databases, and reviews the background check results.</li>
<li><strong>Approval/Rejection:</strong> The administrator updates the contractor's status in the admin dashboard.
<ul>
<li><strong>Approved:</strong> The <code>vettingStatus</code> is set to <code>'approved'</code>, and boolean flags like <code>insuranceVerified</code> are set to <code>true</code>. The contractor's profile becomes active, and they are now eligible for lead matching.</li>
<li><strong>Rejected:</strong> The <code>vettingStatus</code> is set to <code>'rejected'</code>, and the contractor is notified with a reason.</li>
</ul>
</li>
</ol>
<p><strong>7.3.2. Technical Implementation of Vetting</strong><br>
The contractor vetting process is managed through the <code>contractorProfile</code> object within the <code>users</code> collection, as defined in the Data Modeling section. The <code>vettingStatus</code> field (<code>pending</code>, <code>approved</code>, <code>rejected</code>, <code>resubmit_required</code>) acts as the state machine for this workflow. An admin-only dashboard provides the UI for our internal team to review and manage these states.</p>
<p><strong>7.3.3. Secure Document Handling</strong><br>
Contractor documents are sensitive and handled with utmost care.</p>
<ul>
<li>
<p><strong>Storage:</strong> Documents are uploaded directly from the client to a dedicated, locked-down Google Cloud Storage bucket.</p>
</li>
<li>
<p><strong>Path Naming Convention:</strong> Documents are stored using a non-guessable path structure to prevent enumeration attacks: <code>gs://[BUCKET_NAME]/contractor-vetting-docs/{userId}/{documentId}_{fileName}</code>.</p>
</li>
<li>
<p><strong>Storage Security Rules:</strong> Access is strictly controlled via Firebase Storage Security Rules, ensuring only the uploading contractor and authorized administrators can access the files.</p>
</li>
<li>
<p><strong>File:</strong> <code>storage.rules</code></p>
</li>
</ul>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code>rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>

service firebase<span class="token punctuation">.</span><span class="token property-access">storage</span> <span class="token punctuation">{</span>
  match <span class="token operator">/</span>b<span class="token operator">/</span><span class="token punctuation">{</span>bucket<span class="token punctuation">}</span><span class="token operator">/</span>o <span class="token punctuation">{</span>
    
    <span class="token comment">// Public user profile pictures</span>
    match <span class="token operator">/</span>profile<span class="token operator">-</span>pictures<span class="token operator">/</span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">{</span>allPaths<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">;</span>
      allow write<span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">==</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Secure contractor vetting documents</span>
    match <span class="token operator">/</span>contractor<span class="token operator">-</span>vetting<span class="token operator">-</span>docs<span class="token operator">/</span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">{</span>allPaths<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      <span class="token comment">// The user can upload their own documents.</span>
      <span class="token comment">// An admin can read/write to manage the documents.</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">==</span> userId <span class="token operator">||</span> 
                          <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">/</span>databases<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token operator">/</span>documents<span class="token operator">/</span>users<span class="token operator">/</span><span class="token function">$</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">role</span> <span class="token operator">==</span> <span class="token string">'admin'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// AR assessment data for homeowners</span>
    match <span class="token operator">/</span>ar<span class="token operator">-</span>assessments<span class="token operator">/</span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">{</span>allPaths<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> request<span class="token punctuation">.</span><span class="token property-access">auth</span><span class="token punctuation">.</span><span class="token property-access">uid</span> <span class="token operator">==</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Deny all other access by default</span>
    match <span class="token operator">/</span><span class="token punctuation">{</span>allPaths<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token punctuation">,</span> <span class="token literal-property property">write</span><span class="token operator">:</span> <span class="token keyword control-flow keyword-if">if</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t9_security_and_compliance"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Develop Security, Compliance, and Contractor Vetting Plan"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Security Architect"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="aiml-integration-specialist-specialist">AI/ML Integration Specialist Specialist </h3>
<p>Here is the detailed technical plan for the AR Assessment and AI Processing workflow.</p>
<hr>
<h3 id="4-ar-assessment-and-ai-processing-workflow"><strong>4. AR Assessment and AI Processing Workflow</strong> </h3>
<p>This section details the end-to-end asynchronous workflow for the platform's core value proposition: the AR-based home assessment. The architecture is designed to provide a seamless user experience by offloading all heavy processing to a scalable, event-driven backend, ensuring the user's device remains responsive.</p>
<p>The primary goal is to take raw AR data captured by a homeowner, process it through a sophisticated AI pipeline, and return actionable insights and visualizations without blocking the user interface.</p>
<h4 id="41-workflow-overview"><strong>4.1. Workflow Overview</strong> </h4>
<p>The process is broken down into four distinct stages, moving from the client to the backend and back to the client via real-time updates.</p>
<div class="mermaid">sequenceDiagram
    participant C as Homeowner's App (Next.js)
    participant S3 as Google Cloud Storage
    participant API as Next.js API Route
    participant PS as Pub/Sub Topic&lt;br&gt;(ar-assessment-created)
    participant GCF as Cloud Function&lt;br&gt;(arProcessing)
    participant FS as Firestore
    participant AI as AI Services&lt;br&gt;(Gemini &amp; Fal.ai)

    C-&gt;&gt;FS: 1. Create initial document&lt;br&gt;`ar-assessments/{id}`&lt;br&gt;status: 'uploading'
    C-&gt;&gt;S3: 2. Upload AR data (images, measurements)
    S3--&gt;&gt;C: Upload complete
    C-&gt;&gt;API: 3. POST /api/assessments/process&lt;br&gt;Payload: { assessmentId }
    API-&gt;&gt;FS: Update document&lt;br&gt;status: 'processing'
    API-&gt;&gt;PS: 4. Publish message&lt;br&gt;Payload: { assessmentId, userId }
    PS--&gt;&gt;API: Message acknowledged
    API--&gt;&gt;C: 202 Accepted
    Note right of C: UI shows "Analyzing..."

    PS--&gt;&gt;GCF: 5. Trigger function with message
    GCF-&gt;&gt;S3: 6. Download AR data from Storage
    GCF-&gt;&gt;AI: 7. Send data for analysis &amp; visualization
    AI--&gt;&gt;GCF: Return results (hazards, recommendations, image URL)
    GCF-&gt;&gt;FS: 8. Update document with results&lt;br&gt;status: 'complete'

    FS--&gt;&gt;C: 9. Real-time listener fires with updated data
    Note right of C: UI displays full assessment report
</div><hr>
<h4 id="42-step-by-step-implementation-details"><strong>4.2. Step-by-Step Implementation Details</strong> </h4>
<h5 id="step-1--2-client-side-data-capture-and-upload"><strong>Step 1 &amp; 2: Client-Side Data Capture and Upload</strong> </h5>
<ol>
<li>
<p><strong>Data Capture:</strong> The Next.js application will guide the homeowner through capturing the necessary data using their device's camera. This will involve taking specific, well-lit photos of key areas (e.g., doorways, showers, stairways). If the user's device supports LiDAR (e.g., modern iPhones), the app can leverage WebXR or a native wrapper to capture precise measurements, which will be stored as a JSON object.</p>
</li>
<li>
<p><strong>Initial Firestore Document:</strong> Before starting the upload, the client generates a unique ID for the assessment. It then creates a new document in the <code>ar-assessments</code> collection with a default state.</p>
<ul>
<li><strong>Collection:</strong> <code>ar-assessments</code></li>
<li><strong>Document ID:</strong> Auto-generated (e.g., <code>asmt_123xyz</code>)</li>
<li><strong>Initial Data:</strong><pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"userId"</span><span class="token operator">:</span> <span class="token string">"auth.currentUser.uid"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"uploading"</span><span class="token punctuation">,</span>
  <span class="token property">"createdAt"</span><span class="token operator">:</span> <span class="token string">"serverTimestamp()"</span><span class="token punctuation">,</span>
  <span class="token property">"storageRefs"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"results"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ul>
</li>
<li>
<p><strong>Secure Upload to Cloud Storage:</strong> The client uses the Firebase SDK for JavaScript (<code>@firebase/storage</code>) to upload the captured files (images, JSON data) directly to a secure, user-specific path in Google Cloud Storage.</p>
<ul>
<li><strong>Storage Path:</strong> <code>ar-assessments/{userId}/{assessmentId}/raw_image_01.jpg</code></li>
<li>The <code>storage.rules</code> will be configured to only allow authenticated users to write to their own <code>{userId}</code> path, preventing unauthorized uploads.</li>
</ul>
</li>
</ol>
<h5 id="step-3--4-triggering-the-asynchronous-workflow"><strong>Step 3 &amp; 4: Triggering the Asynchronous Workflow</strong> </h5>
<ol>
<li>
<p><strong>API Route Invocation:</strong> Once all files are successfully uploaded, the client updates the Firestore document status to <code>'pending'</code> and makes a <code>POST</code> request to a dedicated Next.js API route.</p>
<ul>
<li><strong>Endpoint:</strong> <code>/api/assessments/process</code></li>
<li><strong>Method:</strong> <code>POST</code></li>
<li><strong>Body:</strong> <code>{ "assessmentId": "asmt_123xyz" }</code></li>
</ul>
</li>
<li>
<p><strong>API Route Logic:</strong> This API route is intentionally lightweight. Its sole responsibilities are:</p>
<ul>
<li><strong>Authentication &amp; Authorization:</strong> Verify the user is signed in and owns the <code>assessmentId</code> they submitted.</li>
<li><strong>Update Status:</strong> Immediately update the Firestore document status to <code>'processing'</code>. This provides instant feedback to the user that their request has been received and is being worked on.</li>
<li><strong>Publish to Pub/Sub:</strong> Use the Google Cloud Pub/Sub Node.js client library to publish a message to the designated topic.</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// /pages/api/assessments/process.ts (simplified)</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> PubSub <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@google-cloud/pubsub'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> firestore <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@/lib/firebase-admin'</span><span class="token punctuation">;</span> <span class="token comment">// Admin SDK instance</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'zod'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> pubSubClient <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PubSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> topicName <span class="token operator">=</span> <span class="token string">'ar-assessment-created'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> schema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span> assessmentId<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-default">default</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. Auth check (NextAuth session)</span>
  <span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span> req <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. Input validation</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> assessmentId <span class="token punctuation">}</span> <span class="token operator">=</span> schema<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. Authorization check (user owns the assessment)</span>
  <span class="token keyword keyword-const">const</span> assessmentRef <span class="token operator">=</span> firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'ar-assessments'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>assessmentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> doc <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> assessmentRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>doc<span class="token punctuation">.</span>exists <span class="token operator">||</span> doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>userId <span class="token operator">!==</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. Update status and publish message</span>
  <span class="token keyword keyword-await">await</span> assessmentRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'processing'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> message <span class="token operator">=</span> <span class="token punctuation">{</span> assessmentId<span class="token punctuation">,</span> userId<span class="token operator">:</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-await">await</span> pubSubClient<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span>topicName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> json<span class="token operator">:</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. Respond to client</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">'Processing started'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li>
</ol>
<h5 id="step-5---8-backend-ai-processing-with-a-cloud-function"><strong>Step 5 - 8: Backend AI Processing with a Cloud Function</strong> </h5>
<p>A powerful, 2nd Generation Google Cloud Function will perform the heavy lifting. Gen 2 functions are built on Cloud Run, offering longer timeouts (up to 60 minutes), more memory, and better performance for intensive tasks.</p>
<ul>
<li><strong>Function Name:</strong> <code>arProcessing</code></li>
<li><strong>Trigger:</strong> Event-driven, from the <code>ar-assessment-created</code> Pub/Sub topic.</li>
<li><strong>Configuration:</strong>
<ul>
<li><strong>Memory:</strong> 2GiB (adjustable based on performance testing).</li>
<li><strong>Timeout:</strong> 5 minutes (adjustable).</li>
<li><strong>Service Account:</strong> A dedicated IAM service account with permissions for Firestore, Cloud Storage, and Secret Manager (to access AI API keys).</li>
</ul>
</li>
</ul>
<p><strong>Function Logic:</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// index.ts for the Cloud Function</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> onMessagePublished <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'firebase-functions/v2/pubsub'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> getStorage <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'firebase-admin/storage'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> getFirestore <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'firebase-admin/firestore'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> GoogleGenerativeAI <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@google/generative-ai'</span><span class="token punctuation">;</span>
<span class="token comment">// import { FalClient } from '@fal-ai/serverless-client'; // Example</span>

<span class="token comment">// Initialize SDKs</span>
<span class="token keyword keyword-const">const</span> firestore <span class="token operator">=</span> <span class="token function">getFirestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> storage <span class="token operator">=</span> <span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> genAI <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">GoogleGenerativeAI</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GEMINI_API_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// const fal = new FalClient({ key: process.env.FAL_AI_KEY });</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> arProcessing <span class="token operator">=</span> <span class="token function">onMessagePublished</span><span class="token punctuation">(</span><span class="token string">'ar-assessment-created'</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> assessmentId<span class="token punctuation">,</span> userId <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token punctuation">.</span>json<span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> assessmentRef <span class="token operator">=</span> firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'ar-assessments'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>assessmentId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Download images from Cloud Storage</span>
    <span class="token keyword keyword-const">const</span> bucket <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>files<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> bucket<span class="token punctuation">.</span><span class="token function">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ar-assessments/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assessmentId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> imageBuffers <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>file <span class="token operator">=&gt;</span> file<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. Prepare data for Gemini</span>
    <span class="token keyword keyword-const">const</span> model <span class="token operator">=</span> genAI<span class="token punctuation">.</span><span class="token function">getGenerativeModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> model<span class="token operator">:</span> <span class="token string">'gemini-1.5-pro-latest'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> prompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      You are a Certified Aging-in-Place Specialist (CAPS). Analyze the following images of a home.
      Identify all potential accessibility hazards and safety risks for an older adult.
      For each hazard, provide a clear, actionable modification recommendation.
      Format your response as a JSON object with two keys: "hazards" and "recommendations".
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> imageParts <span class="token operator">=</span> imageBuffers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>buffer <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      inlineData<span class="token operator">:</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mimeType<span class="token operator">:</span> <span class="token string">'image/jpeg'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. Call Gemini API for analysis</span>
    <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> model<span class="token punctuation">.</span><span class="token function">generateContent</span><span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">,</span> <span class="token operator">...</span>imageParts<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> responseText <span class="token operator">=</span> result<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> analysis <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Contains hazards and recommendations</span>

    <span class="token comment">// 4. Call Fal.ai for visualization (using the primary image)</span>
    <span class="token comment">// const visualizationResult = await fal.run('fal-ai/image-to-image', {</span>
    <span class="token comment">//   image_url: 'URL_to_primary_image_in_storage',</span>
    <span class="token comment">//   prompt: `Add this modification: ${analysis.recommendations[0].details}`</span>
    <span class="token comment">// });</span>
    <span class="token comment">// const visualizationUrl = visualizationResult.images[0].url;</span>
    <span class="token keyword keyword-const">const</span> visualizationUrl <span class="token operator">=</span> <span class="token string">"https://example.com/mock-visualization.jpg"</span><span class="token punctuation">;</span> <span class="token comment">// Placeholder</span>

    <span class="token comment">// 5. Update Firestore with the complete results</span>
    <span class="token keyword keyword-await">await</span> assessmentRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      status<span class="token operator">:</span> <span class="token string">'complete'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'results.hazards'</span><span class="token operator">:</span> analysis<span class="token punctuation">.</span>hazards<span class="token punctuation">,</span>
      <span class="token string-property property">'results.recommendations'</span><span class="token operator">:</span> analysis<span class="token punctuation">.</span>recommendations<span class="token punctuation">,</span>
      <span class="token string-property property">'results.visualizationUrl'</span><span class="token operator">:</span> visualizationUrl<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Successfully processed assessment </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assessmentId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to process assessment </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>assessmentId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-await">await</span> assessmentRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'failed'</span><span class="token punctuation">,</span> <span class="token string-property property">'results.error'</span><span class="token operator">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h5 id="step-9-real-time-ui-update"><strong>Step 9: Real-Time UI Update</strong> </h5>
<p>The Next.js frontend will use a real-time listener from the Firebase SDK to watch for changes on the specific assessment document.</p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// React component snippet</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> doc<span class="token punctuation">,</span> onSnapshot <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'firebase/firestore'</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">AssessmentStatus</span><span class="token punctuation">(</span><span class="token punctuation">{</span> assessmentId <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>assessment<span class="token punctuation">,</span> setAssessment<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> unsub <span class="token operator">=</span> <span class="token function">onSnapshot</span><span class="token punctuation">(</span><span class="token function">doc</span><span class="token punctuation">(</span>firestore<span class="token punctuation">,</span> <span class="token string">'ar-assessments'</span><span class="token punctuation">,</span> assessmentId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>doc<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setAssessment</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unsub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Cleanup listener on unmount</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>assessmentId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>assessment<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>assessment<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'processing'</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Analyzing your space<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>assessment<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'complete'</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token operator">&lt;</span>DisplayResults data<span class="token operator">=</span><span class="token punctuation">{</span>assessment<span class="token punctuation">.</span>results<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>assessment<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'failed'</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>An error occurred<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token comment">// ... other states</span>
<span class="token punctuation">}</span>
</code></pre><p>This ensures that as soon as the Cloud Function completes its work and updates Firestore, the user's screen automatically transitions from a loading state to displaying the full, rich report without requiring a page refresh.</p>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t4_ar_assessment_and_ai_flow"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan AR Assessment and AI Processing Workflow"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"AI/ML Integration Specialist"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="senior-backend-engineer-specialist">Senior Backend Engineer Specialist </h3>
<p>Here is the detailed technical plan for the lead generation and contractor matching workflow for the HOMEase AI platform.</p>
<hr>
<h3 id="5-lead-generation-and-contractor-matching-workflow"><strong>5. Lead Generation and Contractor Matching Workflow</strong> </h3>
<p>This section details the asynchronous, event-driven workflow for handling new lead submissions and matching them with qualified contractors. This architecture is designed for scalability and responsiveness, ensuring the user receives immediate feedback while complex backend processing occurs independently.</p>
<p>The core principle is to decouple the initial lead submission from the computationally intensive matching process. The Next.js API provides a fast, synchronous response to the user, while Google Cloud Pub/Sub and Cloud Functions handle the heavy lifting asynchronously.</p>
<h4 id="51-workflow-sequence-diagram"><strong>5.1. Workflow Sequence Diagram</strong> </h4>
<p>The following diagram illustrates the end-to-end process, from the homeowner's submission to the real-time updates on both homeowner and contractor dashboards.</p>
<div class="mermaid">sequenceDiagram
    participant Homeowner as Homeowner's App (Next.js)
    participant NextJsApi as Next.js API (/api/leads/create)
    participant Firestore
    participant PubSub as Google Cloud Pub/Sub
    participant CloudFunction as leadMatching Function
    participant Contractor as Contractor's App (Next.js)

    Homeowner-&gt;&gt;+NextJsApi: POST /api/leads/create (Lead Data)
    NextJsApi-&gt;&gt;NextJsApi: Validate Input (Zod) &amp; User Auth
    NextJsApi-&gt;&gt;+Firestore: Create Lead doc (status: 'new')
    Firestore--&gt;&gt;-NextJsApi: Return new leadId
    NextJsApi-&gt;&gt;+PubSub: Publish message to 'lead-created' topic (payload: { leadId })
    PubSub--&gt;&gt;-NextJsApi: Acknowledge message
    NextJsApi--&gt;&gt;-Homeowner: Respond 201 Created ({"status": "success", "leadId": ...})

    Note right of Homeowner: Homeowner UI shows "We've received your request!"

    PubSub-&gt;&gt;+CloudFunction: Trigger leadMatching function with message
    CloudFunction-&gt;&gt;+Firestore: Update Lead doc (status: 'matching')
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update

    Note over Homeowner,Contractor: Real-time listener updates UI
    Homeowner-&gt;&gt;Firestore: onSnapshot(leadDoc)
    Firestore--&gt;&gt;Homeowner: Update UI (Status: "Finding Contractors...")

    CloudFunction-&gt;&gt;+Firestore: Query 'users' for approved contractors in service area &amp; specialty
    Firestore--&gt;&gt;-CloudFunction: Return list of potential contractors
    CloudFunction-&gt;&gt;CloudFunction: Run matching algorithm (filter, sort by rating)
    CloudFunction-&gt;&gt;+Firestore: Update Lead doc (status: 'matched', matchedContractorIds: [...])
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update

    Note over Homeowner,Contractor: Real-time listener updates UI
    Homeowner-&gt;&gt;Firestore: onSnapshot(leadDoc)
    Firestore--&gt;&gt;Homeowner: Update UI (Status: "Contractors Found!")
    Contractor-&gt;&gt;Firestore: onSnapshot(leadsQuery)
    Firestore--&gt;&gt;Contractor: New lead appears in dashboard
</div><hr>
<h4 id="52-step-1-lead-submission-nextjs-api-route"><strong>5.2. Step 1: Lead Submission (Next.js API Route)</strong> </h4>
<p>The homeowner initiates the process by submitting a form in the Next.js application. This triggers a <code>POST</code> request to a dedicated API Route handler.</p>
<ul>
<li><strong>File:</strong> <code>app/api/leads/create/route.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> NextResponse <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"next/server"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"zod"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> auth <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/auth"</span><span class="token punctuation">;</span> <span class="token comment">// From NextAuth.js</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> firestore <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/lib/firebase/admin"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> PubSub <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@google-cloud/pubsub"</span><span class="token punctuation">;</span>

<span class="token comment">// Zod schema for validating the incoming request body</span>
<span class="token keyword keyword-const">const</span> createLeadSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  urgency<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"low"</span><span class="token punctuation">,</span> <span class="token string">"medium"</span><span class="token punctuation">,</span> <span class="token string">"high"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  budgetRange<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Budget range is required."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">"Please provide a detailed description."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  arAssessmentId<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Link to an existing AR assessment</span>
  <span class="token comment">// Specialties required for the job, used for matching</span>
  requiredSpecialties<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize Pub/Sub client</span>
<span class="token keyword keyword-const">const</span> pubsub <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PubSub</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  projectId<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GOOGLE_CLOUD_PROJECT_ID</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-const">const</span> topicName <span class="token operator">=</span> <span class="token string">"lead-created"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Authenticate and Authorize the user</span>
    <span class="token keyword keyword-const">const</span> session <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>session<span class="token operator">?.</span>user<span class="token operator">?.</span>role <span class="token operator">!==</span> <span class="token string">"homeowner"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">"Forbidden"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">403</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-const">const</span> homeownerId <span class="token operator">=</span> session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

    <span class="token comment">// 2. Validate the request body</span>
    <span class="token keyword keyword-const">const</span> body <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> validatedData <span class="token operator">=</span> createLeadSchema<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. Create the lead document in Firestore</span>
    <span class="token keyword keyword-const">const</span> leadsCollection <span class="token operator">=</span> firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"leads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> homeownerDoc <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> firestore<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>homeownerId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> homeownerInfo <span class="token operator">=</span> homeownerDoc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> newLead <span class="token operator">=</span> <span class="token punctuation">{</span>
      homeownerId<span class="token punctuation">,</span>
      status<span class="token operator">:</span> <span class="token string">"new"</span><span class="token punctuation">,</span> <span class="token comment">// Initial status</span>
      createdAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      updatedAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>validatedData<span class="token punctuation">,</span>
      <span class="token comment">// Denormalize homeowner info for efficient matching</span>
      homeownerInfo<span class="token operator">:</span> <span class="token punctuation">{</span>
        displayName<span class="token operator">:</span> homeownerInfo<span class="token operator">?.</span>displayName<span class="token punctuation">,</span>
        city<span class="token operator">:</span> homeownerInfo<span class="token operator">?.</span>address<span class="token operator">?.</span>city<span class="token punctuation">,</span>
        state<span class="token operator">:</span> homeownerInfo<span class="token operator">?.</span>address<span class="token operator">?.</span>state<span class="token punctuation">,</span>
        zip<span class="token operator">:</span> homeownerInfo<span class="token operator">?.</span>address<span class="token operator">?.</span>zip<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      matchedContractorIds<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> leadRef <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> leadsCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newLead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> leadId <span class="token operator">=</span> leadRef<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

    <span class="token comment">// 4. Publish a message to Pub/Sub to trigger the matching function</span>
    <span class="token keyword keyword-const">const</span> messageBuffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> leadId<span class="token punctuation">,</span> requiredSpecialties<span class="token operator">:</span> validatedData<span class="token punctuation">.</span>requiredSpecialties <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-await">await</span> pubsub<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span>topicName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> messageBuffer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Published message for leadId: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>leadId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to topic </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>topicName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. Return a success response to the client immediately</span>
    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> leadId <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">201</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error <span class="token keyword keyword-instanceof">instanceof</span> <span class="token class-name">z</span><span class="token punctuation">.</span>ZodError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> error<span class="token punctuation">.</span>errors <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error creating lead:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">"Internal Server Error"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h4 id="53-step-2-asynchronous-matching-google-cloud-function"><strong>5.3. Step 2: Asynchronous Matching (Google Cloud Function)</strong> </h4>
<p>This function listens for new messages on the <code>lead-created</code> Pub/Sub topic and performs the contractor matching logic.</p>
<ul>
<li><strong>File:</strong> <code>functions/src/leads.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> functions <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-functions"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> admin <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-admin"</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize Admin SDK if not already done</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  admin<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-const">const</span> db <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">firestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-const">const</span> <span class="token constant">MAX_MATCHES</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Find up to 3 contractors per lead</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> onLeadCreated <span class="token operator">=</span> functions<span class="token punctuation">.</span>pubsub
  <span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token string">"lead-created"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onPublish</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. Decode the message payload</span>
      <span class="token keyword keyword-const">const</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> leadId<span class="token punctuation">,</span> requiredSpecialties <span class="token punctuation">}</span> <span class="token operator">=</span> payload<span class="token punctuation">;</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Message missing leadId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 2. Fetch the lead document and update its status</span>
      <span class="token keyword keyword-const">const</span> leadRef <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"leads"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>leadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-const">const</span> leadSnapshot <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadSnapshot<span class="token punctuation">.</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Lead with ID: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>leadId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"matching"</span><span class="token punctuation">,</span> updatedAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-const">const</span> leadData <span class="token operator">=</span> leadSnapshot<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>

      <span class="token comment">// 3. Find potential contractors based on service area</span>
      <span class="token keyword keyword-const">const</span> homeownerZip <span class="token operator">=</span> leadData<span class="token punctuation">.</span>homeownerInfo<span class="token punctuation">.</span>zip<span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>homeownerZip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"failed"</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">"Missing homeowner zip code."</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-const">const</span> contractorsQuery <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span> <span class="token string">"=="</span><span class="token punctuation">,</span> <span class="token string">"contractor"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"contractorProfile.vettingStatus"</span><span class="token punctuation">,</span> <span class="token string">"=="</span><span class="token punctuation">,</span> <span class="token string">"approved"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"contractorProfile.serviceAreaZips"</span><span class="token punctuation">,</span> <span class="token string">"array-contains"</span><span class="token punctuation">,</span> homeownerZip<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-const">const</span> contractorsSnapshot <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> contractorsQuery<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>contractorsSnapshot<span class="token punctuation">.</span>empty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No contractors found for zip code: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>homeownerZip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"no_match_found"</span><span class="token punctuation">,</span> updatedAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 4. Filter and rank the contractors in-memory</span>
      <span class="token keyword keyword-let">let</span> matchedContractors <span class="token operator">=</span> contractorsSnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>doc <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Filter by specialty if provided</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>requiredSpecialties <span class="token operator">&amp;&amp;</span> requiredSpecialties<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matchedContractors <span class="token operator">=</span> matchedContractors<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
          requiredSpecialties<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>spec <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>contractorProfile<span class="token operator">?.</span>specialties<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Sort by rating (descending) and then by number of reviews</span>
      matchedContractors<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> ratingA <span class="token operator">=</span> a<span class="token punctuation">.</span>contractorProfile<span class="token operator">?.</span>averageRating <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> ratingB <span class="token operator">=</span> b<span class="token punctuation">.</span>contractorProfile<span class="token operator">?.</span>averageRating <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>ratingB <span class="token operator">!==</span> ratingA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-return">return</span> ratingB <span class="token operator">-</span> ratingA<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-const">const</span> reviewsA <span class="token operator">=</span> a<span class="token punctuation">.</span>contractorProfile<span class="token operator">?.</span>reviewCount <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-const">const</span> reviewsB <span class="token operator">=</span> b<span class="token punctuation">.</span>contractorProfile<span class="token operator">?.</span>reviewCount <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> reviewsB <span class="token operator">-</span> reviewsA<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 5. Select the top N contractors and update the lead</span>
      <span class="token keyword keyword-const">const</span> finalMatchedIds <span class="token operator">=</span> matchedContractors<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_MATCHES</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>finalMatchedIds<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"no_match_found"</span><span class="token punctuation">,</span> updatedAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> leadRef<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">"matched"</span><span class="token punctuation">,</span>
          matchedContractorIds<span class="token operator">:</span> finalMatchedIds<span class="token punctuation">,</span>
          updatedAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Successfully matched </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>finalMatchedIds<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> contractors to lead </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>leadId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error processing lead matching for message: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Optionally, update the lead with a 'failed' status</span>
      <span class="token keyword keyword-const">const</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>leadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"leads"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>leadId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"failed"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><hr>
<h4 id="54-step-3-real-time-frontend-updates-react-hooks-with-firestore"><strong>5.4. Step 3: Real-Time Frontend Updates (React Hooks with Firestore)</strong> </h4>
<p>The frontend uses Firestore's <code>onSnapshot</code> listeners to subscribe to data changes in real-time. This is encapsulated within custom React hooks for clean, reusable logic.</p>
<p><strong>For the Homeowner:</strong> A hook to listen to a single lead's status.</p>
<ul>
<li><strong>File:</strong> <code>hooks/useLeadStatus.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> doc<span class="token punctuation">,</span> onSnapshot <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"firebase/firestore"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/lib/firebase/client"</span><span class="token punctuation">;</span> <span class="token comment">// Client-side Firestore instance</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-function">function</span> <span class="token function">useLeadStatus</span><span class="token punctuation">(</span>leadId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>lead<span class="token punctuation">,</span> setLead<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword keyword-null">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>error<span class="token punctuation">,</span> setError<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span>Error <span class="token operator">|</span> <span class="token keyword keyword-null">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadId<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> leadRef <span class="token operator">=</span> <span class="token function">doc</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"leads"</span><span class="token punctuation">,</span> leadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">onSnapshot</span><span class="token punctuation">(</span>
      leadRef<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>docSnapshot<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>docSnapshot<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setLead</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> docSnapshot<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>docSnapshot<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
          <span class="token function">setError</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Lead not found."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setLead</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error listening to lead status:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Cleanup subscription on unmount</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>leadId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> lead<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>For the Contractor:</strong> A hook to listen for new leads they have been matched with.</p>
<ul>
<li><strong>File:</strong> <code>hooks/useContractorLeads.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> collection<span class="token punctuation">,</span> query<span class="token punctuation">,</span> where<span class="token punctuation">,</span> onSnapshot<span class="token punctuation">,</span> orderBy <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"firebase/firestore"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> db <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">"@/lib/firebase/client"</span><span class="token punctuation">;</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-function">function</span> <span class="token function">useContractorLeads</span><span class="token punctuation">(</span>contractorId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>leads<span class="token punctuation">,</span> setLeads<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span>loading<span class="token punctuation">,</span> setLoading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>contractorId<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> leadsRef <span class="token operator">=</span> <span class="token function">collection</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">"leads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> q <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>
      leadsRef<span class="token punctuation">,</span>
      <span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"matchedContractorIds"</span><span class="token punctuation">,</span> <span class="token string">"array-contains"</span><span class="token punctuation">,</span> contractorId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"createdAt"</span><span class="token punctuation">,</span> <span class="token string">"desc"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-const">const</span> unsubscribe <span class="token operator">=</span> <span class="token function">onSnapshot</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token punctuation">(</span>querySnapshot<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-const">const</span> newLeads <span class="token operator">=</span> querySnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>doc <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLeads</span><span class="token punctuation">(</span>newLeads<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>contractorId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> leads<span class="token punctuation">,</span> loading <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t5_lead_matching_workflow"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Lead Generation and Contractor Matching Workflow"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Senior Backend Engineer"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="devops-engineer-specialist">DevOps Engineer Specialist </h3>
<p>Here is the detailed CI/CD and DevOps plan for the HOMEase AI platform using GitHub Actions and Google Cloud Platform.</p>
<hr>
<h3 id="part-8-cicd-and-devops-plan"><strong>Part 8: CI/CD and DevOps Plan</strong> </h3>
<p>This plan outlines the automated processes for continuous integration and continuous deployment (CI/CD) using GitHub Actions. The strategy is designed for security, reliability, and clear separation of development, staging, and production environments, all hosted on Google Cloud Platform.</p>
<h4 id="81-cicd-strategy-overview"><strong>8.1. CI/CD Strategy Overview</strong> </h4>
<ul>
<li><strong>Source Control:</strong> A single monorepo on GitHub containing the Next.js application, Google Cloud Functions, and Firebase configuration.</li>
<li><strong>Branching Strategy:</strong> A GitFlow-like model will be used to manage deployments:
<ul>
<li><code>feature/*</code>: Developers work on new features in these branches.</li>
<li><code>develop</code>: The integration branch. All feature branches are merged here. A merge to <code>develop</code> triggers a deployment to the <strong>Development</strong> environment.</li>
<li><code>staging</code>: A release candidate branch. Merging <code>develop</code> into <code>staging</code> triggers a deployment to the <strong>Staging</strong> environment for UAT and final validation.</li>
<li><code>main</code>: The production branch. Merging <code>staging</code> into <code>main</code> (after approval) triggers a deployment to the <strong>Production</strong> environment.</li>
</ul>
</li>
<li><strong>Environment Isolation:</strong> Each environment (Dev, Staging, Prod) will correspond to a separate Google Cloud Project to ensure complete resource isolation (databases, functions, storage, secrets).
<ul>
<li>Development: <code>homease-ai-dev</code></li>
<li>Staging: <code>homease-ai-staging</code></li>
<li>Production: <code>homease-ai-prod</code></li>
</ul>
</li>
<li><strong>Authentication:</strong> GitHub Actions will authenticate with GCP using <strong>Workload Identity Federation (WIF)</strong>. This is a secure, keyless mechanism that grants GitHub Actions workflows short-lived access tokens, eliminating the need to store long-lived GCP service account keys as GitHub secrets.</li>
<li><strong>Workflow Triggers:</strong> Workflows will be triggered by pushes and pull requests to specific branches. <code>paths</code> filters will be used to ensure that only relevant workflows run (e.g., only run the backend deployment if files in the <code>/functions</code> directory are changed).</li>
</ul>
<h4 id="82-prerequisite-setup-gcp-and-github-configuration"><strong>8.2. Prerequisite Setup: GCP and GitHub Configuration</strong> </h4>
<p>Before creating the workflows, the following one-time setup is required.</p>
<p><strong>Step 1: Set up Workload Identity Federation in GCP</strong></p>
<p><em>For each GCP project (<code>dev</code>, <code>staging</code>, <code>prod</code>):</em></p>
<ol>
<li><strong>Enable APIs:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>gcloud services <span class="token builtin class-name">enable</span> iam.googleapis.com <span class="token punctuation">\</span>
    iamcredentials.googleapis.com <span class="token punctuation">\</span>
    cloudresourcemanager.googleapis.com <span class="token punctuation">\</span>
    artifactregistry.googleapis.com <span class="token punctuation">\</span>
    run.googleapis.com <span class="token punctuation">\</span>
    secretmanager.googleapis.com
</code></pre></li>
<li><strong>Create a WIF Pool and Provider:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Replace &lt;PROJECT_ID&gt; with your GCP Project ID</span>
gcloud iam workload-identity-pools create <span class="token string">"github-pool"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--project</span><span class="token operator">=</span><span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--location</span><span class="token operator">=</span><span class="token string">"global"</span> <span class="token punctuation">\</span>
  --display-name<span class="token operator">=</span><span class="token string">"GitHub Actions Pool"</span>

<span class="token comment"># Get the full ID of the pool</span>
<span class="token assign-left variable">POOL_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>gcloud iam workload-identity-pools describe <span class="token string">"github-pool"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--project</span><span class="token operator">=</span><span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token parameter variable">--location</span><span class="token operator">=</span><span class="token string">"global"</span> <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">"value(name)"</span><span class="token variable">)</span></span>

<span class="token comment"># Create the provider</span>
gcloud iam workload-identity-pools providers create-oidc <span class="token string">"github-provider"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--project</span><span class="token operator">=</span><span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--location</span><span class="token operator">=</span><span class="token string">"global"</span> <span class="token punctuation">\</span>
  --workload-identity-pool<span class="token operator">=</span><span class="token string">"github-pool"</span> <span class="token punctuation">\</span>
  --display-name<span class="token operator">=</span><span class="token string">"GitHub Actions Provider"</span> <span class="token punctuation">\</span>
  --issuer-uri<span class="token operator">=</span><span class="token string">"https://token.actions.githubusercontent.com"</span> <span class="token punctuation">\</span>
  --attribute-mapping<span class="token operator">=</span><span class="token string">"google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository"</span>
</code></pre></li>
<li><strong>Create a dedicated Service Account (SA) for CI/CD:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># This SA will be used by GitHub Actions to deploy resources</span>
gcloud iam service-accounts create <span class="token string">"github-actions-deployer"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--project</span><span class="token operator">=</span><span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  --display-name<span class="token operator">=</span><span class="token string">"GitHub Actions Deployer SA"</span>
</code></pre></li>
<li><strong>Grant the SA necessary IAM Roles:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Roles for deploying to Cloud Run and managing Artifact Registry</span>
gcloud projects add-iam-policy-binding <span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/run.admin"</span>
gcloud projects add-iam-policy-binding <span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/artifactregistry.admin"</span>
gcloud projects add-iam-policy-binding <span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/iam.serviceAccountUser"</span> <span class="token comment"># Allows SA to act as the Cloud Run runtime SA</span>

<span class="token comment"># Roles for deploying Firebase/Cloud Functions</span>
gcloud projects add-iam-policy-binding <span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/cloudfunctions.admin"</span>
gcloud projects add-iam-policy-binding <span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"serviceAccount:github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/firebase.admin"</span> <span class="token comment"># For deploying Firestore rules, etc.</span>
</code></pre></li>
<li><strong>Allow GitHub Actions to impersonate the Service Account:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Replace &lt;OWNER&gt;/&lt;REPO&gt; with your GitHub repository details</span>
gcloud iam service-accounts add-iam-policy-binding <span class="token string">"github-actions-deployer@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--project</span><span class="token operator">=</span><span class="token string">"&lt;PROJECT_ID&gt;"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span><span class="token operator">=</span><span class="token string">"roles/iam.workloadIdentityUser"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--member</span><span class="token operator">=</span><span class="token string">"principalSet://iam.googleapis.com/<span class="token variable">${POOL_ID}</span>/attribute.repository/&lt;OWNER&gt;/&lt;REPO&gt;"</span>
</code></pre></li>
</ol>
<p><strong>Step 2: Configure GitHub Environments and Secrets</strong></p>
<ol>
<li>
<p>In your GitHub repository, go to <strong>Settings &gt; Environments</strong>.</p>
</li>
<li>
<p>Create three environments: <code>development</code>, <code>staging</code>, and <code>production</code>.</p>
</li>
<li>
<p>For <code>staging</code> and <code>production</code>, add <strong>Protection Rules</strong>, such as requiring an authorized reviewer to approve deployments.</p>
</li>
<li>
<p>Add the following <strong>Environment secrets</strong> to each environment, pointing to the corresponding GCP project values:</p>
<ul>
<li><code>GCP_PROJECT_ID</code>: e.g., <code>homease-ai-dev</code> for the <code>development</code> environment.</li>
<li><code>GCP_WORKLOAD_IDENTITY_PROVIDER</code>: The full path of the WIF provider (e.g., <code>projects/123456/locations/global/workloadIdentityPools/github-pool/providers/github-provider</code>).</li>
<li><code>GCP_SERVICE_ACCOUNT</code>: The email of the SA created above (e.g., <code>github-actions-deployer@homease-ai-dev.iam.gserviceaccount.com</code>).</li>
<li><code>GCP_REGION</code>: e.g., <code>us-central1</code>.</li>
</ul>
</li>
</ol>
<h4 id="83-workflow-1-pr-validation-pr-checkyml"><strong>8.3. Workflow 1: PR Validation (<code>pr-check.yml</code>)</strong> </h4>
<p>This workflow runs on every pull request targeting the <code>develop</code> branch. It ensures code quality before merging.</p>
<p><strong>.github/workflows/pr-check.yml</strong></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> PR Validation

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> develop

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">validate</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Lint<span class="token punctuation">,</span> Type<span class="token punctuation">-</span>Check &amp; Test
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout Repository
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup Node.js
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v4
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'20'</span>
          <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token string">'npm'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Dependencies
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run ESLint
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run lint

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run TypeScript Compiler
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run type<span class="token punctuation">-</span>check

      <span class="token comment"># - name: Run Unit &amp; Integration Tests</span>
      <span class="token comment">#   run: npm run test # Uncomment when tests are added</span>
</code></pre><h4 id="84-workflow-2-frontend-deployment-to-cloud-run-deploy-frontendyml"><strong>8.4. Workflow 2: Frontend Deployment to Cloud Run (<code>deploy-frontend.yml</code>)</strong> </h4>
<p>This workflow builds and deploys the Next.js application to Google Cloud Run. It is triggered on pushes to <code>develop</code>, <code>staging</code>, and <code>main</code>.</p>
<p><strong>.github/workflows/deploy-frontend.yml</strong></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Frontend to Cloud Run

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> develop
      <span class="token punctuation">-</span> staging
      <span class="token punctuation">-</span> main
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'src/**'</span>
      <span class="token punctuation">-</span> <span class="token string">'public/**'</span>
      <span class="token punctuation">-</span> <span class="token string">'next.config.mjs'</span>
      <span class="token punctuation">-</span> <span class="token string">'package*.json'</span>
      <span class="token punctuation">-</span> <span class="token string">'Dockerfile'</span>
      <span class="token punctuation">-</span> <span class="token string">'.github/workflows/deploy-frontend.yml'</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
    <span class="token comment"># Determine environment based on branch name</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> (github.ref == 'refs/heads/main' <span class="token important">&amp;&amp;</span> 'production') <span class="token punctuation">|</span><span class="token punctuation">|</span> (github.ref == 'refs/heads/staging' <span class="token important">&amp;&amp;</span> 'staging') <span class="token punctuation">|</span><span class="token punctuation">|</span> 'development' <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
      <span class="token key atrule">contents</span><span class="token punctuation">:</span> <span class="token string">'read'</span>
      <span class="token key atrule">id-token</span><span class="token punctuation">:</span> <span class="token string">'write'</span> <span class="token comment"># Required for OIDC authentication</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout Repository
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Authenticate to Google Cloud
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">'google-github-actions/auth@v2'</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">workload_identity_provider</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_WORKLOAD_IDENTITY_PROVIDER <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">service_account</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_SERVICE_ACCOUNT <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup Google Cloud SDK
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">'google-github-actions/setup-gcloud@v2'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Configure Docker
        <span class="token key atrule">run</span><span class="token punctuation">:</span> gcloud auth configure<span class="token punctuation">-</span>docker $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_REGION <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>docker.pkg.dev

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and Push Docker Image
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">IMAGE_PATH</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_REGION <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>docker.pkg.dev/$<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_PROJECT_ID <span class="token punctuation">}</span><span class="token punctuation">}</span>/homease<span class="token punctuation">-</span>ai/frontend<span class="token punctuation">:</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.sha <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          docker build -t $IMAGE_PATH .
          docker push $IMAGE_PATH</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to Cloud Run
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">SERVICE_NAME</span><span class="token punctuation">:</span> homease<span class="token punctuation">-</span>ai<span class="token punctuation">-</span>frontend
          <span class="token key atrule">IMAGE_PATH</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_REGION <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>docker.pkg.dev/$<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_PROJECT_ID <span class="token punctuation">}</span><span class="token punctuation">}</span>/homease<span class="token punctuation">-</span>ai/frontend<span class="token punctuation">:</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.sha <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.IMAGE_PATH }} \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --platform managed \
            --allow-unauthenticated \
            --set-secrets=NEXTAUTH_SECRET:NEXTAUTH_SECRET:latest,STRIPE_SECRET_KEY:STRIPE_SECRET_KEY:latest,GOOGLE_GENAI_API_KEY:GOOGLE_GENAI_API_KEY:latest,FIREBASE_SERVICE_ACCOUNT_JSON:FIREBASE_SERVICE_ACCOUNT_JSON:latest \
            --update-env-vars=NEXTAUTH_URL=https://$(gcloud run services describe ${{ env.SERVICE_NAME }} --platform managed --region ${{ secrets.GCP_REGION }} --project ${{ secrets.GCP_PROJECT_ID }} --format 'value(status.url)' | sed 's|https://||')</span>
</code></pre><h4 id="85-workflow-3-backend-deployment-deploy-backendyml"><strong>8.5. Workflow 3: Backend Deployment (<code>deploy-backend.yml</code>)</strong> </h4>
<p>This workflow deploys Google Cloud Functions and Firebase assets (Firestore rules, Storage rules). It uses the Firebase CLI for deployment.</p>
<p><strong>.github/workflows/deploy-backend.yml</strong></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy Backend to Firebase &amp; GCP

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> develop
      <span class="token punctuation">-</span> staging
      <span class="token punctuation">-</span> main
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'functions/**'</span>
      <span class="token punctuation">-</span> <span class="token string">'firestore.rules'</span>
      <span class="token punctuation">-</span> <span class="token string">'storage.rules'</span>
      <span class="token punctuation">-</span> <span class="token string">'.firebaserc'</span>
      <span class="token punctuation">-</span> <span class="token string">'firebase.json'</span>
      <span class="token punctuation">-</span> <span class="token string">'.github/workflows/deploy-backend.yml'</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> (github.ref == 'refs/heads/main' <span class="token important">&amp;&amp;</span> 'production') <span class="token punctuation">|</span><span class="token punctuation">|</span> (github.ref == 'refs/heads/staging' <span class="token important">&amp;&amp;</span> 'staging') <span class="token punctuation">|</span><span class="token punctuation">|</span> 'development' <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span>
      <span class="token key atrule">contents</span><span class="token punctuation">:</span> <span class="token string">'read'</span>
      <span class="token key atrule">id-token</span><span class="token punctuation">:</span> <span class="token string">'write'</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout Repository
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup Node.js
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v4
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'20'</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Firebase CLI
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install <span class="token punctuation">-</span>g firebase<span class="token punctuation">-</span>tools

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Authenticate to Google Cloud
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> <span class="token string">'google-github-actions/auth@v2'</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">workload_identity_provider</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_WORKLOAD_IDENTITY_PROVIDER <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">service_account</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GCP_SERVICE_ACCOUNT <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Function Dependencies
        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm ci
        <span class="token key atrule">working-directory</span><span class="token punctuation">:</span> ./functions

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to Firebase
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          # The .firebaserc file maps the alias to the GCP Project ID.
          # The correct project is selected automatically based on the alias.
          firebase deploy --project ${{ secrets.GCP_PROJECT_ID }} --only functions,firestore,storage --force</span>
</code></pre><h4 id="86-required-configuration-files"><strong>8.6. Required Configuration Files</strong> </h4>
<p>For the backend deployment to work seamlessly, the following files must be present in the repository root.</p>
<p><strong>.firebaserc</strong><br>
This file maps a project alias to the actual GCP Project ID. The Firebase CLI uses this to target the correct environment.</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"projects"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"development"</span><span class="token operator">:</span> <span class="token string">"homease-ai-dev"</span><span class="token punctuation">,</span>
    <span class="token property">"staging"</span><span class="token operator">:</span> <span class="token string">"homease-ai-staging"</span><span class="token punctuation">,</span>
    <span class="token property">"production"</span><span class="token operator">:</span> <span class="token string">"homease-ai-prod"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><em>Note: The workflow shown above uses the <code>GCP_PROJECT_ID</code> secret directly for simplicity and explicitness. The <code>.firebaserc</code> file provides a powerful alternative where you could pass an alias (e.g., <code>firebase deploy --project development</code>) instead.</em></p>
<p><strong>firebase.json</strong><br>
This file defines which assets to deploy.</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"functions"</span><span class="token punctuation">,</span>
    <span class="token property">"runtime"</span><span class="token operator">:</span> <span class="token string">"nodejs20"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"firestore"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token string">"firestore.rules"</span><span class="token punctuation">,</span>
    <span class="token property">"indexes"</span><span class="token operator">:</span> <span class="token string">"firestore.indexes.json"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token string">"storage.rules"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t8_cicd_and_devops_plan"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Plan CI/CD Pipeline with GitHub Actions for GCP"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"DevOps Engineer"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="backend-engineer-with-stripe-integration-experience-specialist">Backend Engineer with Stripe Integration Experience Specialist </h3>
<p>Here is the detailed technical plan for the payment and contractor onboarding system for the HOMEase AI platform.</p>
<hr>
<h3 id="7-payment-and-contractor-onboarding-system"><strong>7. Payment and Contractor Onboarding System</strong> </h3>
<p>This section details the architecture for contractor onboarding, verification, and the pay-per-lead transaction system. The entire workflow is built on <strong>Stripe Connect</strong> for robust identity verification and <strong>Stripe Checkout</strong> for secure payments. The system is designed to be automated and scalable, using Google Cloud Functions to handle asynchronous events from Stripe via webhooks, ensuring the platform's data integrity.</p>
<h4 id="71-stripe-integration-strategy-stripe-connect-express"><strong>7.1. Stripe Integration Strategy: Stripe Connect Express</strong> </h4>
<p>To balance rapid development with a professional, branded user experience, HOMEase will utilize <strong>Stripe Connect Express</strong>. This approach offers several key advantages:</p>
<ul>
<li><strong>Fast Go-to-Market:</strong> Stripe provides a pre-built, co-branded, and mobile-optimized onboarding UI, significantly reducing frontend development effort.</li>
<li><strong>Reduced Compliance Burden:</strong> Stripe handles the collection and verification of sensitive information (like bank details and tax IDs), helping HOMEase meet KYC (Know Your Customer) requirements.</li>
<li><strong>Platform Control:</strong> HOMEase remains the primary platform. Contractors interact with HOMEase for leads, and Stripe handles the financial verification and payout logistics in the background.</li>
<li><strong>Scalability:</strong> The Express model is designed to scale from a few contractors to thousands without requiring significant re-architecture.</li>
</ul>
<h4 id="72-contractor-onboarding-and-verification-flow"><strong>7.2. Contractor Onboarding and Verification Flow</strong> </h4>
<p>The goal of this flow is to create a Stripe Connected Account for each contractor, link it to their HOMEase profile, and use Stripe's verification process as a key part of the platform's vetting protocol.</p>
<p><strong>Sequence Diagram:</strong></p>
<div class="mermaid">sequenceDiagram
    participant ContractorApp as Contractor Dashboard (Next.js)
    participant NextJsApi as Next.js API Route
    participant CloudFunction as createStripeAccount Function
    participant Firestore
    participant Stripe

    ContractorApp-&gt;&gt;+NextJsApi: POST /api/contractor/onboarding/start
    NextJsApi-&gt;&gt;+CloudFunction: Invoke createStripeAccount (or call Stripe SDK directly)
    CloudFunction-&gt;&gt;+Stripe: stripe.accounts.create({ type: 'express', ... })
    Stripe--&gt;&gt;-CloudFunction: Return Stripe Account ID (acct_...)
    CloudFunction-&gt;&gt;+Firestore: Update user/{userId}: { contractorProfile.stripeAccountId: 'acct_...' }
    Firestore--&gt;&gt;-CloudFunction: Acknowledge update
    CloudFunction-&gt;&gt;+Stripe: stripe.accountLinks.create({ account: 'acct_...', ... })
    Stripe--&gt;&gt;-CloudFunction: Return one-time onboarding URL
    CloudFunction--&gt;&gt;-NextJsApi: Return onboarding URL
    NextJsApi--&gt;&gt;-ContractorApp: Respond with { onboardingUrl: 'https://connect.stripe.com/...' }
    ContractorApp-&gt;&gt;Stripe: Redirect user to onboardingUrl

    Note right of Stripe: Contractor completes onboarding form on Stripe's site.

    Stripe-&gt;&gt;Stripe: Verifies information.
    Stripe--&gt;&gt;ContractorApp: Redirects user back to HOMEase (return_url)

    Note over Stripe, CloudFunction: Later, asynchronously...
    Stripe-&gt;&gt;CloudFunction: POST /stripe-webhook (Event: 'account.updated')
    CloudFunction-&gt;&gt;CloudFunction: Verify Stripe Signature
    CloudFunction-&gt;&gt;Firestore: Query for user with stripeAccountId
    CloudFunction-&gt;&gt;Firestore: Update user/{userId}: { contractorProfile.vettingStatus: 'approved' }
</div><p><strong>Implementation Steps:</strong></p>
<ol>
<li>
<p><strong>Initiate Onboarding:</strong></p>
<ul>
<li>In the contractor dashboard, a user without a Stripe account sees a prompt: "Complete Your Profile to Access Leads."</li>
<li>Clicking this button triggers a request to a Next.js API route: <code>POST /api/contractor/onboarding/start</code>.</li>
</ul>
</li>
<li>
<p><strong>Create Stripe Account &amp; Link (Server-Side):</strong></p>
<ul>
<li>The API route authenticates the user and invokes a Google Cloud Function (or uses the Admin SDK directly) to perform the following actions:
<ul>
<li><strong>Check for Existing Account:</strong> First, check if a <code>stripeAccountId</code> already exists for this user in Firestore to prevent duplicates.</li>
<li><strong>Create Stripe Express Account:</strong> Call <code>stripe.accounts.create</code> with the contractor's email and business type.</li>
<li><strong>Store Account ID:</strong> Save the returned Stripe account ID (e.g., <code>acct_123...</code>) to the contractor's profile in Firestore: <code>users/{userId}/contractorProfile/stripeAccountId</code>.</li>
<li><strong>Generate Onboarding Link:</strong> Call <code>stripe.accountLinks.create</code>, providing the <code>account</code> ID, a <code>refresh_url</code> (if the link expires), and a <code>return_url</code> (where the user lands after completion, e.g., <code>/contractor/dashboard?onboarding=complete</code>).</li>
<li><strong>Return URL:</strong> The API route responds to the frontend with the generated one-time URL.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Redirect and Return:</strong></p>
<ul>
<li>The Next.js frontend receives the URL and performs a <code>window.location.href</code> redirect, sending the contractor to the Stripe-hosted onboarding flow.</li>
<li>Upon completion, Stripe redirects the user back to the specified <code>return_url</code>. The UI can then show a "Verification in progress" message.</li>
</ul>
</li>
<li>
<p><strong>Asynchronous Verification (Webhook):</strong></p>
<ul>
<li>The verification is handled by the <code>stripe-webhook</code> Cloud Function, which listens for the <code>account.updated</code> event. This is detailed in section 7.4.</li>
<li>When the webhook receives confirmation that the account has <code>charges_enabled: true</code>, it updates the contractor's <code>vettingStatus</code> in Firestore from <code>pending_stripe</code> to <code>approved</code>. The contractor can now purchase leads.</li>
</ul>
</li>
</ol>
<hr>
<h4 id="73-pay-per-lead-transaction-flow"><strong>7.3. Pay-Per-Lead Transaction Flow</strong> </h4>
<p>This flow enables an <code>approved</code> contractor to purchase a lead securely using Stripe Checkout.</p>
<p><strong>Sequence Diagram:</strong></p>
<div class="mermaid">sequenceDiagram
    participant ContractorApp as Contractor Dashboard (Next.js)
    participant NextJsApi as Next.js API (/api/leads/purchase)
    participant Firestore
    participant Stripe

    ContractorApp-&gt;&gt;+NextJsApi: POST /api/leads/purchase ( { leadId: '...' } )
    NextJsApi-&gt;&gt;NextJsApi: Auth Check (isApprovedContractor?)
    NextJsApi-&gt;&gt;+Firestore: Get lead details (price, description)
    Firestore--&gt;&gt;-NextJsApi: Return lead data
    NextJsApi-&gt;&gt;+Stripe: stripe.checkout.sessions.create({ ..., metadata: { leadId, contractorId } })
    Stripe--&gt;&gt;-NextJsApi: Return Checkout Session ID (cs_...)
    NextJsApi--&gt;&gt;-ContractorApp: Respond with { sessionId: 'cs_...' }
    ContractorApp-&gt;&gt;Stripe: stripe.redirectToCheckout({ sessionId: 'cs_...' })

    Note right of Stripe: Contractor enters payment details on Stripe's secure page.

    Stripe--&gt;&gt;ContractorApp: Redirects to success_url on payment completion.

    Note over Stripe, CloudFunction: Asynchronously...
    Stripe-&gt;&gt;CloudFunction: POST /stripe-webhook (Event: 'checkout.session.completed')
    CloudFunction-&gt;&gt;CloudFunction: Verify Signature &amp; Parse Metadata
    CloudFunction-&gt;&gt;Firestore: Update lead/{leadId}: { purchasedBy: [..., contractorId] }
    CloudFunction-&gt;&gt;Firestore: Create transactions/{txId} document
</div><p><strong>Implementation Steps:</strong></p>
<ol>
<li>
<p><strong>Initiate Purchase:</strong></p>
<ul>
<li>An approved contractor clicks a "Purchase Lead for $XX" button on a lead details page.</li>
<li>The frontend sends a <code>POST</code> request to <code>app/api/leads/purchase/route.ts</code> with the <code>leadId</code>.</li>
</ul>
</li>
<li>
<p><strong>Create Checkout Session (Server-Side):</strong></p>
<ul>
<li>The API route handler performs these critical steps:
<ul>
<li><strong>Authorization:</strong> Verifies the user is an authenticated contractor with a <code>vettingStatus</code> of <code>approved</code>.</li>
<li><strong>Fetch Lead Price:</strong> Retrieves the lead from Firestore to get the current price.</li>
<li><strong>Create Stripe Checkout Session:</strong> Calls <code>stripe.checkout.sessions.create</code> with the following parameters:
<ul>
<li><code>payment_method_types</code>: <code>['card']</code></li>
<li><code>line_items</code>: An array with the lead's name/description and price.</li>
<li><code>mode</code>: <code>'payment'</code></li>
<li><code>success_url</code>: <code>https://yourdomain.com/leads/{LEAD_ID}?purchase=success</code></li>
<li><code>cancel_url</code>: <code>https://yourdomain.com/leads/{LEAD_ID}?purchase=cancelled</code></li>
<li><strong><code>metadata</code></strong>: This is essential for reconciliation. Include <code>{ leadId: leadId, contractorId: session.user.id }</code>.</li>
</ul>
</li>
<li><strong>Return Session ID:</strong> The API responds with the <code>sessionId</code> from Stripe.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Redirect to Checkout:</strong></p>
<ul>
<li>The frontend uses the Stripe.js library and the received <code>sessionId</code> to redirect the contractor to the secure, Stripe-hosted payment page. <code>await stripe.redirectToCheckout({ sessionId });</code></li>
</ul>
</li>
<li>
<p><strong>Unlock Lead Access (Webhook):</strong></p>
<ul>
<li>The actual fulfillment (granting access to the lead's full details) is handled asynchronously by the <code>stripe-webhook</code> function upon receiving the <code>checkout.session.completed</code> event. This prevents users from gaining access if the payment ultimately fails.</li>
</ul>
</li>
</ol>
<hr>
<h4 id="74-secure-webhook-handler-google-cloud-function"><strong>7.4. Secure Webhook Handler (Google Cloud Function)</strong> </h4>
<p>A single, robust Google Cloud Function with an HTTP trigger will serve as the endpoint for all Stripe events. This centralizes logic and security.</p>
<ul>
<li><strong>File:</strong> <code>functions/src/stripe.ts</code></li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> functions <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-functions"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token operator">*</span> <span class="token keyword keyword-as">as</span> admin <span class="token keyword keyword-from">from</span> <span class="token string">"firebase-admin"</span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> Stripe <span class="token keyword keyword-from">from</span> <span class="token string">"stripe"</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize Stripe with secret key from environment variables</span>
<span class="token keyword keyword-const">const</span> stripe <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Stripe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">STRIPE_SECRET_KEY</span><span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  apiVersion<span class="token operator">:</span> <span class="token string">"2024-04-10"</span><span class="token punctuation">,</span>
  typescript<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize Firebase Admin SDK</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  admin<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword keyword-const">const</span> db <span class="token operator">=</span> admin<span class="token punctuation">.</span><span class="token function">firestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * A single webhook handler for all Stripe events.
 */</span>
<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> stripeWebhookHandler <span class="token operator">=</span> functions<span class="token punctuation">.</span>https<span class="token punctuation">.</span><span class="token function">onRequest</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> sig <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"stripe-signature"</span><span class="token punctuation">]</span> <span class="token keyword keyword-as">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> webhookSecret <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">STRIPE_WEBHOOK_SECRET</span><span class="token operator">!</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-let">let</span> event<span class="token operator">:</span> Stripe<span class="token punctuation">.</span>Event<span class="token punctuation">;</span>

  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Verify the request is genuinely from Stripe</span>
    event <span class="token operator">=</span> stripe<span class="token punctuation">.</span>webhooks<span class="token punctuation">.</span><span class="token function">constructEvent</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>rawBody<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> webhookSecret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Stripe webhook signature verification failed."</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Webhook Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Handle the event based on its type</span>
  <span class="token class-name"><span class="token keyword keyword-switch">switch</span></span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-case">case</span> <span class="token string">"account.updated"</span><span class="token operator">:</span>
      <span class="token keyword keyword-await">await</span> <span class="token function">handleAccountUpdated</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>object <span class="token keyword keyword-as">as</span> Stripe<span class="token punctuation">.</span>Account<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-case">case</span> <span class="token string">"checkout.session.completed"</span><span class="token operator">:</span>
      <span class="token keyword keyword-await">await</span> <span class="token function">handleCheckoutSessionCompleted</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>object <span class="token keyword keyword-as">as</span> Stripe<span class="token punctuation">.</span>Checkout<span class="token punctuation">.</span>Session<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token comment">// ... handle other event types as needed</span>
    <span class="token keyword keyword-default">default</span><span class="token operator">:</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unhandled event type </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span><span class="token keyword keyword-type">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. Acknowledge receipt of the event</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> received<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Handles the 'account.updated' event to update contractor vetting status.
 */</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">handleAccountUpdated</span><span class="token punctuation">(</span>account<span class="token operator">:</span> Stripe<span class="token punctuation">.</span>Account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> stripeAccountId <span class="token operator">=</span> account<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> usersRef <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> q <span class="token operator">=</span> usersRef<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"contractorProfile.stripeAccountId"</span><span class="token punctuation">,</span> <span class="token string">"=="</span><span class="token punctuation">,</span> stripeAccountId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-const">const</span> snapshot <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> q<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span>empty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No user found for Stripe account ID: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stripeAccountId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-const">const</span> userDoc <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>docs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> newStatus <span class="token operator">=</span> account<span class="token punctuation">.</span>charges_enabled <span class="token operator">?</span> <span class="token string">"approved"</span> <span class="token operator">:</span> <span class="token string">"action_required"</span><span class="token punctuation">;</span>

  <span class="token comment">// Update the user's vetting status in Firestore</span>
  <span class="token keyword keyword-await">await</span> userDoc<span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"contractorProfile.vettingStatus"</span><span class="token operator">:</span> newStatus <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Updated vetting status for user </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userDoc<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newStatus<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Handles 'checkout.session.completed' to fulfill a lead purchase.
 */</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">handleCheckoutSessionCompleted</span><span class="token punctuation">(</span>session<span class="token operator">:</span> Stripe<span class="token punctuation">.</span>Checkout<span class="token punctuation">.</span>Session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> leadId<span class="token punctuation">,</span> contractorId <span class="token punctuation">}</span> <span class="token operator">=</span> session<span class="token punctuation">.</span>metadata<span class="token operator">!</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>leadId <span class="token operator">||</span> <span class="token operator">!</span>contractorId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Missing metadata (leadId or contractorId) in checkout session."</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-const">const</span> leadRef <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"leads"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>leadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-const">const</span> transactionRef <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"transactions"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Use session ID for idempotency</span>

  <span class="token comment">// Use a transaction to ensure atomicity</span>
  <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span><span class="token function">runTransaction</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>transaction<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> txDoc <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> transaction<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>transactionRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>txDoc<span class="token punctuation">.</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Transaction </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>session<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> already processed.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span> <span class="token comment">// Idempotency check</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Grant access to the lead</span>
    transaction<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>leadRef<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      purchasedBy<span class="token operator">:</span> admin<span class="token punctuation">.</span>firestore<span class="token punctuation">.</span>FieldValue<span class="token punctuation">.</span><span class="token function">arrayUnion</span><span class="token punctuation">(</span>contractorId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      status<span class="token operator">:</span> <span class="token string">"sold"</span> <span class="token comment">// Or a similar status</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Log the transaction for accounting</span>
    transaction<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>transactionRef<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      contractorId<span class="token punctuation">,</span>
      leadId<span class="token punctuation">,</span>
      amount<span class="token operator">:</span> session<span class="token punctuation">.</span>amount_total<span class="token punctuation">,</span>
      currency<span class="token operator">:</span> session<span class="token punctuation">.</span>currency<span class="token punctuation">,</span>
      stripePaymentIntentId<span class="token operator">:</span> session<span class="token punctuation">.</span>payment_intent<span class="token punctuation">,</span>
      createdAt<span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  functions<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Fulfilled purchase of lead </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>leadId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for contractor </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>contractorId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="75-firestore-data-model-updates"><strong>7.5. Firestore Data Model Updates</strong> </h4>
<p>To support this system, the following fields will be added to the Firestore data models:</p>
<ul>
<li>
<p><strong><code>users</code> collection (for contractors):</strong></p>
<ul>
<li><code>contractorProfile</code> (map):
<ul>
<li><code>stripeAccountId</code> (string, e.g., "acct_...")</li>
<li><code>vettingStatus</code> (string, e.g., "pending_stripe", "action_required", "approved", "rejected")</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>leads</code> collection:</strong></p>
<ul>
<li><code>price</code> (number): The cost of the lead in cents.</li>
<li><code>purchasedBy</code> (array of strings): A list of <code>userId</code>s of contractors who have purchased this lead.</li>
<li><code>status</code> (string): Updated to "sold" or similar once purchased.</li>
</ul>
</li>
<li>
<p><strong><code>transactions</code> collection (New):</strong></p>
<ul>
<li><em>Document ID</em>: Stripe Checkout Session ID (<code>cs_...</code>) or Payment Intent ID (<code>pi_...</code>) for idempotency.</li>
<li><code>contractorId</code> (string)</li>
<li><code>leadId</code> (string)</li>
<li><code>amount</code> (number)</li>
<li><code>currency</code> (string)</li>
<li><code>status</code> (string, e.g., "succeeded")</li>
<li><code>createdAt</code> (timestamp)</li>
</ul>
</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_id"</span><span class="token operator">:</span> <span class="token string">"t7_payments_and_onboarding"</span><span class="token punctuation">,</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Design Payment and Contractor Onboarding System"</span><span class="token punctuation">,</span>
  <span class="token property">"expertise"</span><span class="token operator">:</span> <span class="token string">"Backend Engineer with Stripe Integration Experience"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="results-integrator">Results Integrator </h3>
<p>Here is a solid, detailed technical architecture plan for the HOMEase AI platform, synthesized from the provided documentation and designed for execution by a development team.</p>
<h3 id="executive-summary-1"><strong>Executive Summary</strong> </h3>
<p>This document presents the comprehensive technical architecture for the HOMEase AI platform, a lead generation service connecting homeowners with aging-in-place (AIP) contractors. The architecture is designed to be scalable, secure, and cost-efficient, directly supporting the business's strategic pivot to a pure-play lead generation model.</p>
<p>The platform is built exclusively on the Google Cloud Platform (GCP) ecosystem, leveraging a serverless, event-driven model to achieve rapid development cycles and operational efficiency. The core components include a Next.js 15 frontend hosted on <strong>Google Cloud Run</strong> (explicitly excluding Vercel), a suite of backend services using <strong>Google Cloud Functions</strong>, and a unified data layer with <strong>Firebase Firestore, Authentication, and Storage</strong>.</p>
<p>Key architectural features include:</p>
<ul>
<li><strong>Asynchronous Workflows:</strong> Core processes like AR assessment analysis and contractor matching are handled asynchronously using Google Cloud Pub/Sub, ensuring a responsive user experience.</li>
<li><strong>Role-Based Access Control (RBAC):</strong> A robust security model using Firebase Custom Claims and NextAuth.js enforces strict permissions for homeowners, contractors, and administrators across the entire application stack.</li>
<li><strong>Integrated Payments &amp; Vetting:</strong> A seamless contractor onboarding and payment system is built using Stripe Connect and Stripe Checkout, automated via secure webhooks.</li>
<li><strong>Automated CI/CD:</strong> A complete DevOps pipeline using GitHub Actions and Google Cloud's Workload Identity Federation enables secure, automated deployments to isolated development, staging, and production environments.</li>
</ul>
<p>This plan provides a blueprint for building a high-performance, secure, and scalable platform poised to capture a significant share of the growing AIP market.</p>
<hr>
<h3 id="1-high-level-system-architecture-2"><strong>1. High-Level System Architecture</strong> </h3>
<p>HOMEase AI employs a serverless, event-driven architecture hosted entirely on GCP. This model is chosen for its inherent scalability, pay-per-use cost structure, and reduced operational overhead.</p>
<h4 id="11-core-technology-stack-2"><strong>1.1. Core Technology Stack</strong> </h4>
<ul>
<li><strong>Frontend &amp; Primary Backend:</strong> Next.js 15 (App Router, TypeScript)</li>
<li><strong>Deployment Host:</strong> Google Cloud Run</li>
<li><strong>Database:</strong> Google Firestore (NoSQL, real-time)</li>
<li><strong>Authentication:</strong> Firebase Authentication with NextAuth.js v5</li>
<li><strong>File Storage:</strong> Google Cloud Storage (via Firebase Storage SDK)</li>
<li><strong>Background Processing:</strong> Google Cloud Functions (2nd Gen)</li>
<li><strong>Messaging/Event Bus:</strong> Google Cloud Pub/Sub</li>
<li><strong>AI/ML:</strong> Google Gemini API (Analysis), <a href="http://Fal.ai">Fal.ai</a> (Visualization)</li>
<li><strong>Payments:</strong> Stripe (Connect &amp; Checkout)</li>
<li><strong>CI/CD:</strong> GitHub Actions &amp; Google Cloud Build</li>
</ul>
<h4 id="12-architecture-diagram-2"><strong>1.2. Architecture Diagram</strong> </h4>
<p>The diagram below illustrates the interaction between system components. The Next.js application on Cloud Run serves as the primary interface, orchestrating calls to backend services and responding to real-time database updates.</p>
<div class="mermaid">graph TD
    subgraph "User Devices"
        A[Homeowner's Browser/Mobile]
        B[Contractor's Browser/Mobile]
    end

    subgraph "Google Cloud Platform"
        subgraph "Application &amp; API Tier"
            C(Next.js App on Cloud Run)
        end

        subgraph "Asynchronous Processing Tier"
            D(Pub/Sub Topic: lead-created)
            E(Pub/Sub Topic: ar-assessment-created)
            F[Cloud Function: leadMatching]
            G[Cloud Function: arProcessing]
            P[Cloud Function: stripeWebhookHandler]
        end

        subgraph "Data &amp; Persistence Tier"
            H(Firebase Authentication)
            I(Firestore Database)
            J(Cloud Storage)
        end

        subgraph "External Services"
            K(Google Gemini API)
            L(Stripe API)
            M(Fal.ai API)
        end
    end

    %% User Interactions &amp; Synchronous Flow
    A -- HTTPS Requests --&gt; C
    B -- HTTPS Requests --&gt; C
    C -- Authenticates User --&gt; H
    C -- Reads/Writes Data --&gt; I
    C -- Uploads/Reads Files --&gt; J
    C -- Initiates Onboarding/Payment --&gt; L

    %% Asynchronous Workflows
    C -- Publishes Message --&gt; D
    C -- Publishes Message --&gt; E
    D -- Triggers --&gt; F
    E -- Triggers --&gt; G
    L -- Sends Webhooks --&gt; P

    %% Backend Processing
    F -- Reads/Writes Data --&gt; I
    G -- Reads Files --&gt; J
    G -- Calls for Analysis --&gt; K
    G -- Calls for Visualization --&gt; M
    G -- Writes Results --&gt; I
    P -- Writes Payment/Vetting Status --&gt; I

    %% Real-time Updates
    I -- Real-time Updates (Listeners) --&gt; A
    I -- Real-time Updates (Listeners) --&gt; B
</div><hr>
<h3 id="2-data-modeling--persistence-1"><strong>2. Data Modeling &amp; Persistence</strong> </h3>
<p>The data layer is built on Firestore, a scalable NoSQL database. The schema is designed with denormalization to optimize for the application's primary read patterns.</p>
<h4 id="21-firestore-collection-schema-1"><strong>2.1. Firestore Collection Schema</strong> </h4>
<ul>
<li><strong><code>users</code></strong>: Stores profiles for all roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>), identified by their Firebase Auth UID. Contractor profiles include a <code>contractorProfile</code> map containing vetting status, specialties, service area ZIPs, and their <code>stripeAccountId</code>.</li>
<li><strong><code>leads</code></strong>: Represents a homeowner's request for work. It includes denormalized homeowner info, the <code>arAssessmentId</code>, status (<code>new</code>, <code>matching</code>, <code>matched</code>, <code>sold</code>), price, and arrays for <code>matchedContractorIds</code> and <code>purchasedBy</code> contractor IDs.</li>
<li><strong><code>ar-assessments</code></strong>: Contains the results of an AR scan, including <code>status</code> (<code>processing</code>, <code>complete</code>), links to raw data in Cloud Storage, and the final <code>results</code> from the Gemini AI analysis.</li>
<li><strong><code>projects</code></strong>: Tracks a confirmed job between a homeowner and contractor, linking the lead, participants, and final scope.</li>
<li><strong><code>chats</code></strong>: Manages conversation threads, with a <code>messages</code> subcollection for individual messages.</li>
<li><strong><code>reviews</code></strong>: Stores ratings and comments for completed projects. An <code>onWrite</code> Cloud Function aggregates these reviews to update a contractor's average rating in their <code>users</code> document.</li>
<li><strong><code>transactions</code></strong>: Logs all payment events from Stripe for accounting and auditing, using the Stripe session or payment intent ID as the document ID for idempotency.</li>
</ul>
<h4 id="22-firestore-security-rules-1"><strong>2.2. Firestore Security Rules</strong> </h4>
<p>Security rules are the primary mechanism for enforcing data access control at the database level. They are non-negotiable and protect data even if the application backend is compromised.</p>
<ul>
<li><strong>Users</strong>: Users can read and update their own profiles. Public contractor information is readable by any authenticated user. Admins have full access.</li>
<li><strong>Leads</strong>: A lead can be read only by its owner, a matched contractor, or an admin. Only homeowners can create leads.</li>
<li><strong>AR Assessments</strong>: Can only be accessed by the user who created it or an admin.</li>
<li><strong>Chats &amp; Messages</strong>: Can only be accessed by the participants of the chat.</li>
<li><strong>Reviews</strong>: Are public to read but can only be created by the homeowner of a completed project. Reviews are immutable by users.</li>
</ul>
<hr>
<h3 id="3-authentication--role-based-access-control-rbac-1"><strong>3. Authentication &amp; Role-Based Access Control (RBAC)</strong> </h3>
<p>A multi-layered RBAC strategy ensures that users can only perform actions and access data appropriate for their role.</p>
<ol>
<li><strong>Authentication Provider</strong>: <strong>NextAuth.js v5</strong> is used with the <strong>Firebase Auth provider</strong>. Firebase securely manages user credentials, social logins, and issues ID tokens.</li>
<li><strong>Authoritative Role Source</strong>: <strong>Firebase Custom Claims</strong> are the single source of truth for user roles (<code>homeowner</code>, <code>contractor</code>, <code>admin</code>).</li>
<li><strong>Role Assignment</strong>: Upon user signup, a Cloud Function (<code>onUserCreate</code>) is triggered. It reads the user's intended role (set during the signup flow) from a temporary Firestore document and uses the Firebase Admin SDK to write the role as a custom claim to the user's auth token. This process is entirely server-side and secure from client-side manipulation.</li>
<li><strong>Session Propagation</strong>: NextAuth.js is configured to decode the user's ID token upon login, extract the custom <code>role</code> claim, and inject it into the session object.</li>
<li><strong>Permission Enforcement</strong>:
<ul>
<li><strong>Next.js (Server Components &amp; API Routes)</strong>: Server-side code checks <code>session.user.role</code> to authorize access to pages and API endpoints.</li>
<li><strong>Next.js (Client Components)</strong>: The UI is conditionally rendered based on the <code>role</code> available in the <code>useSession()</code> hook.</li>
<li><strong>Cloud Functions</strong>: Callable Functions automatically receive a verified auth <code>context</code> containing the decoded token and its claims, allowing for role checks at the start of any backend process.</li>
<li><strong>Firestore Rules</strong>: Rules use helper functions to read the user's role from their request token (<code>request.auth.token.role</code>) to enforce database-level permissions.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="4-core-workflows-1"><strong>4. Core Workflows</strong> </h3>
<p>The platform's primary functions are designed as decoupled, asynchronous workflows to ensure scalability and a responsive user experience.</p>
<h4 id="41-ar-assessment--ai-processing-1"><strong>4.1. AR Assessment &amp; AI Processing</strong> </h4>
<ol>
<li><strong>Upload</strong>: The homeowner's app uploads raw AR data (images, measurements) directly to a secure path in <strong>Google Cloud Storage</strong>.</li>
<li><strong>Trigger</strong>: Upon successful upload, the app calls a lightweight Next.js API route (<code>/api/ar-assessments/process</code>), which updates the assessment's status in Firestore to <code>'processing'</code> and publishes a message to the <code>ar-assessment-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Process</strong>: An event-driven <strong>Cloud Function (<code>arProcessing</code>)</strong> is triggered by the Pub/Sub message. It downloads the data from Storage, sends it to the <strong>Google Gemini API</strong> for hazard detection and recommendations, and calls <strong><a href="http://Fal.ai">Fal.ai</a></strong> to generate "after" visualizations.</li>
<li><strong>Update</strong>: The function writes the complete analysis back to the assessment's Firestore document and updates its status to <code>'complete'</code>.</li>
<li><strong>Notify</strong>: The homeowner's app, listening for real-time changes to the document, automatically updates the UI to display the full report.</li>
</ol>
<h4 id="42-lead-generation--contractor-matching-1"><strong>4.2. Lead Generation &amp; Contractor Matching</strong> </h4>
<ol>
<li><strong>Submission</strong>: A homeowner submits a lead request via a Next.js form. The API route (<code>/api/leads/create</code>) validates the data, creates a new lead document in Firestore with a status of <code>'new'</code>, and immediately publishes a message with the <code>leadId</code> to the <code>lead-created</code> <strong>Pub/Sub topic</strong>.</li>
<li><strong>Matching</strong>: The <code>leadMatching</code> <strong>Cloud Function</strong> is triggered. It updates the lead status to <code>'matching'</code>, then queries the <code>users</code> collection for approved contractors whose <code>serviceAreaZips</code> and <code>specialties</code> match the lead's requirements.</li>
<li><strong>Ranking &amp; Update</strong>: The function ranks the potential matches (e.g., by average rating, review count) and updates the lead document in Firestore with an array of the top <code>matchedContractorIds</code> and a new status of <code>'matched'</code>.</li>
<li><strong>Notify</strong>: Both the homeowner and the matched contractors receive real-time updates in their dashboards via Firestore listeners, informing them of the match.</li>
</ol>
<h4 id="43-contractor-onboarding--payments-1"><strong>4.3. Contractor Onboarding &amp; Payments</strong> </h4>
<ol>
<li><strong>Onboarding</strong>: The system uses <strong>Stripe Connect Express</strong>. A contractor initiates onboarding from their dashboard, triggering a server-side process that creates a Stripe Express account and generates a one-time onboarding link. The contractor is redirected to Stripe's co-branded UI to submit their business and bank details.</li>
<li><strong>Verification</strong>: Stripe handles the identity verification asynchronously. When the account is verified, Stripe sends an <code>account.updated</code> event to a secure webhook endpoint.</li>
<li><strong>Pay-Per-Lead Purchase</strong>: An approved contractor can purchase a lead. This action calls a Next.js API route that creates a <strong>Stripe Checkout Session</strong>, embedding the <code>leadId</code> and <code>contractorId</code> in the session's <code>metadata</code>. The contractor is redirected to Stripe's secure payment page.</li>
<li><strong>Webhook Handling</strong>: A single, secure <strong>Cloud Function (<code>stripeWebhookHandler</code>)</strong> with an HTTP trigger acts as the endpoint for all Stripe webhooks. It verifies the Stripe signature of every incoming request.
<ul>
<li>On an <code>account.updated</code> event, it updates the contractor's <code>vettingStatus</code> in Firestore to <code>'approved'</code>.</li>
<li>On a <code>checkout.session.completed</code> event, it reads the <code>metadata</code> to identify the lead and contractor, then updates the lead document in Firestore to grant the contractor access.</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-frontend-architecture-nextjs-15-on-cloud-run-1"><strong>5. Frontend Architecture (Next.js 15 on Cloud Run)</strong> </h3>
<p>The frontend is a monolithic Next.js 15 application using the App Router, prioritizing performance and maintainability with a "Server-First" approach.</p>
<ul>
<li><strong>Component Strategy</strong>: <strong>React Server Components (RSCs)</strong> are used by default to fetch data and render UI on the server, minimizing client-side JavaScript. <strong>Client Components (<code>'use client'</code>)</strong> are used only when necessary for interactivity, such as forms, AR uploaders, and real-time chat windows.</li>
<li><strong>Directory Structure</strong>: A feature-based directory structure (<code>/src/app/(dashboard)/contractor</code>, <code>/src/components/features/leads</code>) keeps the codebase organized.</li>
<li><strong>Styling</strong>: <strong>Tailwind CSS</strong> with <strong>Shadcn/UI</strong> provides a modern, utility-first design system.</li>
<li><strong>Deployment Container</strong>: The application is containerized using a multi-stage <code>Dockerfile</code> that builds the app and copies the optimized standalone output into a lean <code>node:20-alpine</code> image. This creates a small, secure image ideal for Cloud Run.</li>
</ul>
<hr>
<h3 id="6-deployment--devops-cicd-1"><strong>6. Deployment &amp; DevOps (CI/CD)</strong> </h3>
<p>A fully automated CI/CD pipeline using GitHub Actions ensures reliable and frequent deployments to GCP.</p>
<ul>
<li><strong>Environments</strong>: Three isolated GCP projects (<code>homease-ai-dev</code>, <code>-staging</code>, <code>-prod</code>) provide complete separation for Development, Staging, and Production environments.</li>
<li><strong>Branching Strategy</strong>: A GitFlow model is used. Merges to <code>develop</code>, <code>staging</code>, and <code>main</code> branches trigger deployments to their corresponding environments.</li>
<li><strong>Secure Authentication</strong>: <strong>Workload Identity Federation (WIF)</strong> provides a secure, keyless mechanism for GitHub Actions to authenticate with GCP. This eliminates the need to store long-lived service account keys as GitHub secrets.</li>
<li><strong>Workflows</strong>:
<ol>
<li><strong>PR Validation</strong>: On every pull request to <code>develop</code>, a workflow runs linting, type-checking, and tests to maintain code quality.</li>
<li><strong>Frontend Deployment</strong>: On pushes to key branches, a workflow builds the Next.js Docker image, pushes it to <strong>Google Artifact Registry</strong>, and deploys it as a new revision to <strong>Google Cloud Run</strong>. Secrets are securely injected from <strong>Google Secret Manager</strong>.</li>
<li><strong>Backend Deployment</strong>: A separate workflow, triggered by changes in the <code>/functions</code> directory or rules files, uses the Firebase CLI to deploy Cloud Functions, Firestore rules, and Storage rules to the appropriate GCP project.</li>
</ol>
</li>
</ul>
<hr>
<h3 id="7-security-compliance-and-vetting-2"><strong>7. Security, Compliance, and Vetting</strong> </h3>
<p>Security is a foundational principle, integrated at every layer of the platform.</p>
<ul>
<li><strong>Application Security</strong>:
<ul>
<li><strong>Content Security Policy (CSP)</strong>: A strict CSP is enforced via Next.js middleware to prevent XSS attacks.</li>
<li><strong>Input Validation</strong>: <strong>Zod</strong> is used to validate all incoming data on every API endpoint and Cloud Function, preventing injection attacks and ensuring data integrity.</li>
<li><strong>Secure Headers</strong>: Standard security headers (HSTS, X-Content-Type-Options) are configured.</li>
</ul>
</li>
<li><strong>Compliance</strong>:
<ul>
<li><strong>CCPA</strong>: The platform provides users with the right to know, delete, and opt-out of data sales (which HOMEase does not do).</li>
<li><strong>'HIPAA-lite'</strong>: While not a covered entity, HOMEase AI treats home accessibility data as sensitive. We practice <strong>data minimization</strong> (collecting only functional needs, not medical diagnoses) and enforce strict access controls.</li>
<li><strong>Encryption</strong>: All data is encrypted in transit (TLS 1.3) and at rest (Google-managed AES-256).</li>
</ul>
</li>
<li><strong>Contractor Vetting</strong>: A multi-stage process ensures contractor quality.
<ol>
<li><strong>Submission</strong>: Contractors upload licenses and proof of insurance to a secure Cloud Storage bucket.</li>
<li><strong>Verification</strong>: An internal admin team verifies these documents and initiates a third-party background check (e.g., via Checkr).</li>
<li><strong>Status Management</strong>: The contractor's <code>vettingStatus</code> (<code>pending</code>, <code>approved</code>, <code>rejected</code>) is managed in their Firestore document via an admin-only dashboard. Only <code>'approved'</code> contractors are eligible for lead matching.</li>
<li><strong>Secure Storage</strong>: Firebase Storage rules ensure that vetting documents can only be uploaded by the contractor and read by authorized administrators.</li>
</ol>
</li>
</ul>
<p><strong>Metadata:</strong></p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"subtask_count"</span><span class="token operator">:</span> <span class="token number">9</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>